<!DOCTYPE html>
<html lang="zh-Hans">

<!-- Head tag -->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!--Description-->
    
        <meta name="description" content="编程范式，三棵树，element更新，其他">
    

    <!--Author-->
    
        <meta name="author" content="Leven">
    

    <!-- Title -->
    
    <title>Flutter的一些探索 | Leven</title>

    <!-- Bootstrap Core CSS -->
    <link href="//cdn.bootcss.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    
<link rel="stylesheet" href="/css/style.css">


    <!-- Custom Fonts -->
    <link href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Noto+Serif:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

    <!-- jQuery -->
    <script src="//cdn.bootcss.com/jquery/2.2.1/jquery.min.js"></script>
    <!-- Bootstrap -->
    <script src="//cdn.bootcss.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
<meta name="generator" content="Hexo 5.3.0"></head>

<body>

    <!-- Content -->
    <section class="article-container">
    <!-- Back Home -->
    <a class="nav-back" href="/">
    <i class="fa fa-puzzle-piece"></i>
</a>

        <!-- Page Header -->
        <header class="intro-header">
            <div class="container">
                <div class="row">
                    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                        <div class="post-heading">
                            <h1>
                                Flutter的一些探索
                            </h1>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Post Content -->
        <article>
            <div class="container">
                <div class="row">
                    <!-- Post Main Content -->
                    <div class="post-content col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                        <p>编程范式，三棵树，element更新，其他</p>
<a id="more"></a>
<h2 id="编程范式"><a href="#编程范式" class="headerlink" title="编程范式"></a>编程范式</h2><h3 id="命令式"><a href="#命令式" class="headerlink" title="命令式"></a>命令式</h3><p>给计算机下命令，告诉他我们想做什么。</p>
<p>如果Flutter写成命令式</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> text = <span class="keyword">new</span> Text();</span><br><span class="line"><span class="keyword">var</span> title = <span class="string">&quot;Hello World&quot;</span>;</span><br><span class="line">text.setContent(title);</span><br><span class="line"><span class="comment">// 修改数据</span></span><br><span class="line"><span class="keyword">var</span> title = <span class="string">&quot;Hello Flutter&quot;</span>;</span><br><span class="line">text.setContent(title);</span><br></pre></td></tr></table></figure>
<h3 id="声明式"><a href="#声明式" class="headerlink" title="声明式"></a>声明式</h3><p>声明目标的依赖。当依赖改变的时候，目标自动更新。</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> title = <span class="string">&quot;Hello World&quot;</span></span><br><span class="line">Text(title)</span><br><span class="line"><span class="comment">// 更新数据</span></span><br><span class="line">setState(&#123;</span><br><span class="line">	title = <span class="string">&quot;Hello Flutter&quot;</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>Widget是如何自动刷新的？</p>
<h2 id="消息流通方式"><a href="#消息流通方式" class="headerlink" title="消息流通方式"></a>消息流通方式</h2><ul>
<li>链式</li>
</ul>
<p>树形数据结构。</p>
<p><img src="/images/iOSer%E5%AF%B9Flutter%E7%9A%84%E4%B8%80%E4%BA%9B%E6%8E%A2%E7%B4%A2/Untitled.png" alt="Untitled.png"></p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Node</span> </span>&#123;</span><br><span class="line">	Node Parent</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class SingleChildNode : Node &#123;</span><br><span class="line">	Node child</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">clase MultiChildNode : Node &#123;</span><br><span class="line">	[Node] children</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>中心管理者</li>
</ul>
<p>EventBus: 订阅-广播 </p>
<p><img src="/images/iOSer%E5%AF%B9Flutter%E7%9A%84%E4%B8%80%E4%BA%9B%E6%8E%A2%E7%B4%A2/Untitled1.png" alt="iOSer对Flutter的一些探索/Untitled1.png"></p>
<p>小孩才做选择，Flutter全都要！</p>
<h2 id="Widget，Element，RenderObject"><a href="#Widget，Element，RenderObject" class="headerlink" title="Widget，Element，RenderObject"></a>Widget，Element，RenderObject</h2><p><img src="/images/iOSer%E5%AF%B9Flutter%E7%9A%84%E4%B8%80%E4%BA%9B%E6%8E%A2%E7%B4%A2/Untitled2.png" alt="iOSer对Flutter的一些探索/Untitled2.png"></p>
<h3 id="StatelessWidget-StatefulWidget"><a href="#StatelessWidget-StatefulWidget" class="headerlink" title="StatelessWidget StatefulWidget"></a>StatelessWidget StatefulWidget</h3><p>Widget是页面渲染的配置数据。 通常情况下每一帧都会重新构建一个新的 Widget 对象，而无法知道之前的状态。StatefulWidget 通过关联一个 State 对象实现状态的保存。</p>
<p>Text，Container，Image</p>
<h3 id="ProxyWidget"><a href="#ProxyWidget" class="headerlink" title="ProxyWidget"></a>ProxyWidget</h3><p>不干“实事”。数据的中转组件。InheritedWidget，ParentDataWidget</p>
<h3 id="RenderObjectWidget"><a href="#RenderObjectWidget" class="headerlink" title="RenderObjectWidget"></a>RenderObjectWidget</h3><p>传递渲染数据的配置给RenderObject</p>
<ul>
<li>LeafRenderObjectWidget — RawImage</li>
<li>SingleChildRenderObjectWidget — Padding，Align</li>
<li>MultiChildRenderObjectWidget — Flex，Wrap，RichText</li>
</ul>
<p>StatefulWidget、StatelessWidget 更像是组合型的 widget，通常用二者就可以构建出复杂的上层界面；RenderObjectWidget 具体实现 layout、paint 工作；ProxyWidget 通常用于数据共享。</p>
<h3 id="三棵树"><a href="#三棵树" class="headerlink" title="三棵树"></a>三棵树</h3><p><img src="/images/iOSer%E5%AF%B9Flutter%E7%9A%84%E4%B8%80%E4%BA%9B%E6%8E%A2%E7%B4%A2/Untitled3.png" alt="iOSer对Flutter的一些探索/Untitled3.png"></p>
<ol>
<li>Widget Tree： Widget 是 Flutter 面向开发者的上层接口，我们通过 widget 的层层嵌套，会形成一颗 Widget 树，一个 Widget 可在多个位置复用。Flutter Framework 层为我们提供了一些常用的包装或者容器的 Widget，比如 Container，其内部继续嵌套了其他 Widget，如 Padding、Align 等等。所以，开发者编写的 Widget 树和实际生成的 Widget 树都会略有差别。如图中虚线圆形标注的 ColorBox、RawImage 等。</li>
<li>Element Tree ：每一个 Widget 都会对应一个 Element，只不过 Element 分类不同</li>
<li>RenderObject Tree：RenderObject 只负责最终的测量、布局和绘制，因此最终的 RenderObject Tree 是 Element Tree 剔除掉哪些包装，最后组织而成的 Tree</li>
</ol>
<p><strong>为啥有那么多树？</strong></p>
<p>原因有两个：</p>
<ol>
<li>分层：Framework 将复杂的内部设计、渲染逻辑与开发接口隔离开，应用层只需关注 Widget 开发即可。</li>
<li>高效：Tree 最大的共同特点就是快取，因为 Element、RenderObject 销毁重建成本很高，一旦可以复用 ，那么快取可以大幅减少这种开销。比如：当 Element 不需要重建时，更新 Widget 的引用就可以了；Layer Tree 的设计是将绘制图层分开，方便提取和合成，合成层中的 transform 和 opacity 效果，都只是几何变换、透明度变换等，不会触发 layout 和 paint，直接由 GPU 完成即可。</li>
</ol>
<p>手动更新界面。</p>
<h2 id="setState"><a href="#setState" class="headerlink" title="setState"></a>setState</h2><p>setState =》_element!.markNeedsBuild(); =》owner!.scheduleBuildFor(this); </p>
<p>=》_dirtyElements.add(element)</p>
<p><strong>BuildOwner</strong></p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// This method is called by [handleDrawFrame], which itself is called</span></span><br><span class="line"><span class="comment">/// automatically by the engine when it is time to lay out and paint a</span></span><br><span class="line"><span class="comment">/// frame.</span></span><br><span class="line"><span class="keyword">void</span> <span class="function"><span class="title">drawFrame</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">	buildOwner!.buildScope(renderViewElement!);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">void</span> <span class="function"><span class="title">buildScope</span>(<span class="params">Element context, [VoidCallback? callback]</span>)</span> &#123;</span><br><span class="line">	<span class="keyword">while</span> (index &lt; dirtyCount) &#123;</span><br><span class="line">		_dirtyElements[index].rebuild();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>rebuild 重新生成 child widget以及slot</p>
<h2 id="InheritedWidget"><a href="#InheritedWidget" class="headerlink" title="InheritedWidget"></a>InheritedWidget</h2><p>使用案例</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义</span></span><br><span class="line">MyInheritedWidget <span class="keyword">extends</span> IneritedWidget &#123;</span><br><span class="line">	final <span class="built_in">String</span> text;</span><br><span class="line">  MyInheritedWidget(&#123;Key? key, required Widget child, required <span class="built_in">this</span>.childWidgets&#125;) : <span class="built_in">super</span>(key: key, <span class="attr">child</span>: child);</span><br><span class="line"></span><br><span class="line">  @override</span><br><span class="line">  bool <span class="function"><span class="title">updateShouldNotify</span>(<span class="params">covariant InheritedWidget oldWidget</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> MyInheritedWid<span class="keyword">get</span> <span class="title">of</span>(<span class="params">BuildContext context</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> context.dependOnInheritedWidgetOfExactType&lt;MyInheritedWidget&gt;() <span class="keyword">as</span> MyInheritedWidget;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 使用</span></span><br><span class="line"><span class="built_in">String</span> text = <span class="string">&quot;A&quot;</span></span><br><span class="line">Wid<span class="keyword">get</span> <span class="title">build</span>(<span class="params">BuildContext context</span>) &#123;</span><br><span class="line">	Container(</span><br><span class="line">	child: MyInheritedWidget(</span><br><span class="line">		text: text</span><br><span class="line">		child: Build(builder: (context) &#123;</span><br><span class="line">			Container(</span><br><span class="line">				child: Text(MyIneritedWidget.of(context).text)</span><br><span class="line">				)</span><br><span class="line">			&#125;</span><br><span class="line">		)</span><br><span class="line">	)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">setState(&#123;</span><br><span class="line">	text = <span class="string">&quot;B&quot;</span></span><br><span class="line">&#125;) </span><br></pre></td></tr></table></figure>
<p>源码解读</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">abstract <span class="class"><span class="keyword">class</span> <span class="title">InheritedWidget</span> <span class="keyword">extends</span> <span class="title">ProxyWidget</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> InheritedWidget(&#123;Key? key, required Widget child&#125;) : <span class="built_in">super</span>(key: key, <span class="attr">child</span>: child);</span><br><span class="line">  @override</span><br><span class="line">  InheritedElement createElement() =&gt; InheritedElement(<span class="built_in">this</span>);</span><br><span class="line">  @protected</span><br><span class="line">  bool updateShouldNotify(covariant InheritedWidget oldWidget);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Element</span></span><br><span class="line">	@override</span><br><span class="line">  InheritedWid<span class="keyword">get</span> <span class="title">dependOnInheritedElement</span>(<span class="params">InheritedElement ancestor, &#123;<span class="built_in">Object</span>? aspect&#125;</span>) &#123;</span><br><span class="line">    assert(ancestor != <span class="literal">null</span>);</span><br><span class="line">    _dependencies ??= HashSet&lt;InheritedElement&gt;();</span><br><span class="line">    _dependencies!.add(ancestor);</span><br><span class="line">    **ancestor.updateDependencies(<span class="built_in">this</span>, aspect);**</span><br><span class="line">    <span class="keyword">return</span> ancestor.widget;</span><br><span class="line">  &#125;</span><br><span class="line">	</span><br><span class="line"><span class="comment">//element mount方法里</span></span><br><span class="line"><span class="comment">//InheritedElement</span></span><br><span class="line">	@override</span><br><span class="line">  <span class="keyword">void</span> <span class="function"><span class="title">_updateInheritance</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    assert(_lifecycleState == _ElementLifecycle.active);</span><br><span class="line">    final <span class="built_in">Map</span>&lt;Type, InheritedElement&gt;? incomingWidgets = _parent?._inheritedWidgets;</span><br><span class="line">    <span class="keyword">if</span> (incomingWidgets != <span class="literal">null</span>)</span><br><span class="line">      _inheritedWidgets = HashMap&lt;Type, InheritedElement&gt;.from(incomingWidgets);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      _inheritedWidgets = HashMap&lt;Type, InheritedElement&gt;();</span><br><span class="line">    _inheritedWidgets![widget.runtimeType] = <span class="built_in">this</span>;</span><br><span class="line">  &#125;</span><br><span class="line">	@protected</span><br><span class="line">  <span class="keyword">void</span> <span class="function"><span class="title">setDependencies</span>(<span class="params">Element dependent, <span class="built_in">Object</span>? value</span>)</span> &#123;</span><br><span class="line">    _dependents[dependent] = value;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">	@protected</span><br><span class="line">  <span class="keyword">void</span> <span class="function"><span class="title">updated</span>(<span class="params">covariant ProxyWidget oldWidget</span>)</span> &#123;</span><br><span class="line">    notifyClients(oldWidget);</span><br><span class="line">  &#125;</span><br><span class="line">	@override</span><br><span class="line">  <span class="keyword">void</span> <span class="function"><span class="title">notifyClients</span>(<span class="params">InheritedWidget oldWidget</span>)</span> &#123;</span><br><span class="line">    assert(_debugCheckOwnerBuildTargetExists(<span class="string">&#x27;notifyClients&#x27;</span>));</span><br><span class="line">    <span class="keyword">for</span> (final Element dependent <span class="keyword">in</span> _dependents.keys) &#123;</span><br><span class="line">      assert(() &#123;</span><br><span class="line">        <span class="comment">// check that it really is our descendant</span></span><br><span class="line">        Element? ancestor = dependent._parent;</span><br><span class="line">        <span class="keyword">while</span> (ancestor != <span class="built_in">this</span> &amp;&amp; ancestor != <span class="literal">null</span>) ancestor = ancestor._parent;</span><br><span class="line">        <span class="keyword">return</span> ancestor == <span class="built_in">this</span>;</span><br><span class="line">      &#125;());</span><br><span class="line">      <span class="comment">// check that it really depends on us</span></span><br><span class="line">      assert(dependent._dependencies!.contains(<span class="built_in">this</span>));</span><br><span class="line">      notifyDependent(oldWidget, dependent);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Element</span></span><br><span class="line">	@mustCallSuper</span><br><span class="line">  <span class="keyword">void</span> <span class="function"><span class="title">didChangeDependencies</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    assert(_lifecycleState == _ElementLifecycle.active); <span class="comment">// otherwise markNeedsBuild is a no-op</span></span><br><span class="line">    assert(_debugCheckOwnerBuildTargetExists(<span class="string">&#x27;didChangeDependencies&#x27;</span>));</span><br><span class="line">    markNeedsBuild(); <span class="comment">// 走setState 一样的流程</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h2 id="Element刷新流程"><a href="#Element刷新流程" class="headerlink" title="Element刷新流程"></a>Element刷新流程</h2><p>rebuild 重新生成 child widget。Element何时创建和刷新？</p>
<p><img src="/images/iOSer%E5%AF%B9Flutter%E7%9A%84%E4%B8%80%E4%BA%9B%E6%8E%A2%E7%B4%A2/Untitled3.png" alt="iOSer对Flutter的一些探索/Untitled3.png"></p>
<ul>
<li><p>案例</p>
  <figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_StatefulContainerState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">StatefulContainer</span>&gt; </span>&#123;</span><br><span class="line">  final Color color =</span><br><span class="line">      Color.fromARGB(Random().nextInt(<span class="number">255</span>), Random().nextInt(<span class="number">255</span>), Random().nextInt(<span class="number">255</span>), Random().nextInt(<span class="number">255</span>));</span><br><span class="line"></span><br><span class="line">  @override</span><br><span class="line">  Wid<span class="keyword">get</span> <span class="title">build</span>(<span class="params">BuildContext context</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> Container(</span><br><span class="line">      width: <span class="number">100</span>,</span><br><span class="line">      height: <span class="number">100</span>,</span><br><span class="line">      color: color,</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_MyHomePageState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">MyHomePage</span>&gt; </span>&#123;</span><br><span class="line">  List&lt;Widget&gt; childWidget = [</span><br><span class="line">    StatefulContainer(), <span class="comment">// key: UniqueKey()</span></span><br><span class="line">    StatefulContainer(),</span><br><span class="line">  ];</span><br><span class="line">	</span><br><span class="line">  <span class="keyword">void</span> <span class="function"><span class="title">_incrementCounter</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    setState(() &#123;</span><br><span class="line">			childWidget = childWidget.reversed.toList();</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  @override</span><br><span class="line">  Wid<span class="keyword">get</span> <span class="title">build</span>(<span class="params">BuildContext context</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> Scaffold(</span><br><span class="line">      appBar: AppBar(</span><br><span class="line">        title: Text(widget.title),</span><br><span class="line">      ),</span><br><span class="line">      body: Row(</span><br><span class="line">        child: childWidget</span><br><span class="line">      ),</span><br><span class="line">      floatingActionButton: FloatingActionButton(</span><br><span class="line">        onPressed: _incrementCounter,</span><br><span class="line">        tooltip: <span class="string">&#x27;Increment&#x27;</span>,</span><br><span class="line">        child: Icon(Icons.add),</span><br><span class="line">      ), <span class="comment">// This trailing comma makes auto-formatting nicer for build methods.</span></span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h3 id="更新源码"><a href="#更新源码" class="headerlink" title="更新源码"></a>更新源码</h3></li>
</ul>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Widget</span></span><br><span class="line"><span class="keyword">static</span> bool <span class="function"><span class="title">canUpdate</span>(<span class="params">Widget oldWidget, Widget newWidget</span>)</span> &#123;</span><br><span class="line">   <span class="keyword">return</span> oldWidget.runtimeType == newWidget.runtimeType &amp;&amp; oldWidget.key == newWidget.key;</span><br><span class="line"> &#125;	</span><br><span class="line"><span class="comment">// Element</span></span><br><span class="line">@protected</span><br><span class="line"> @pragma(<span class="string">&#x27;vm:prefer-inline&#x27;</span>)</span><br><span class="line"> Element? <span class="function"><span class="title">updateChild</span>(<span class="params">Element? child, Widget? newWidget, <span class="built_in">Object</span>? newSlot</span>)</span> &#123;</span><br><span class="line">   <span class="keyword">if</span> (newWidget == <span class="literal">null</span>) &#123;</span><br><span class="line">     <span class="keyword">if</span> (child != <span class="literal">null</span>) deactivateChild(child);</span><br><span class="line">     <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   final Element newChild;</span><br><span class="line">   <span class="keyword">if</span> (child != <span class="literal">null</span>) &#123;</span><br><span class="line">     bool hasSameSuperclass = <span class="literal">true</span>;</span><br><span class="line">     <span class="keyword">if</span> (hasSameSuperclass &amp;&amp; child.widget == newWidget) &#123;</span><br><span class="line">       <span class="keyword">if</span> (child.slot != newSlot) updateSlotForChild(child, newSlot);</span><br><span class="line">       newChild = child;</span><br><span class="line">     &#125; <span class="keyword">else</span> <span class="keyword">if</span> (hasSameSuperclass &amp;&amp; Widget.canUpdate(child.widget, newWidget)) &#123;</span><br><span class="line">       <span class="keyword">if</span> (child.slot != newSlot) updateSlotForChild(child, newSlot);</span><br><span class="line">       child.update(newWidget);</span><br><span class="line">       newChild = child;</span><br><span class="line">     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">       deactivateChild(child);</span><br><span class="line">       newChild = inflateWidget(newWidget, newSlot);</span><br><span class="line">     &#125;</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">     newChild = inflateWidget(newWidget, newSlot);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> newChild;</span><br><span class="line"> &#125;</span><br><span class="line"><span class="comment">// RenderObjectElement</span></span><br><span class="line">@override</span><br><span class="line"> <span class="keyword">void</span> <span class="function"><span class="title">update</span>(<span class="params">covariant RenderObjectWidget newWidget</span>)</span> &#123;</span><br><span class="line">   <span class="built_in">super</span>.update(newWidget);</span><br><span class="line">   widget.updateRenderObject(<span class="built_in">this</span>, renderObject);</span><br><span class="line">   _dirty = <span class="literal">false</span>;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// MultiChildRenderObjectElement</span></span><br><span class="line">@override</span><br><span class="line"> <span class="keyword">void</span> <span class="function"><span class="title">update</span>(<span class="params">MultiChildRenderObjectWidget newWidget</span>)</span> &#123;</span><br><span class="line">   <span class="built_in">super</span>.update(newWidget);</span><br><span class="line">   assert(widget == newWidget);</span><br><span class="line">   _children = updateChildren(_children, widget.children, <span class="attr">forgottenChildren</span>: _forgottenChildren);</span><br><span class="line">   _forgottenChildren.clear();</span><br><span class="line"> &#125;</span><br><span class="line">@protected</span><br><span class="line"> List&lt;Element&gt; updateChildren(List&lt;Element&gt; oldChildren, List&lt;Widget&gt; newWidgets,</span><br><span class="line">     &#123;<span class="built_in">Set</span>&lt;Element&gt;? forgottenChildren, List&lt;<span class="built_in">Object</span>?&gt;? slots&#125;) &#123;</span><br><span class="line">   assert(oldChildren != <span class="literal">null</span>);</span><br><span class="line">   assert(newWidgets != <span class="literal">null</span>);</span><br><span class="line">   assert(slots == <span class="literal">null</span> || newWidgets.length == slots.length);</span><br><span class="line"></span><br><span class="line">   Element? <span class="function"><span class="title">replaceWithNullIfForgotten</span>(<span class="params">Element child</span>)</span> &#123;</span><br><span class="line">     <span class="keyword">return</span> forgottenChildren != <span class="literal">null</span> &amp;&amp; forgottenChildren.contains(child) ? <span class="literal">null</span> : child;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="built_in">Object</span>? <span class="function"><span class="title">slotFor</span>(<span class="params">int newChildIndex, Element? previousChild</span>)</span> &#123;</span><br><span class="line">     <span class="keyword">return</span> slots != <span class="literal">null</span> ? slots[newChildIndex] : IndexedSlot&lt;Element?&gt;(newChildIndex, previousChild);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// This attempts to diff the new child list (newWidgets) with</span></span><br><span class="line">   <span class="comment">// the old child list (oldChildren), and produce a new list of elements to</span></span><br><span class="line">   <span class="comment">// be the new list of child elements of this element. The called of this</span></span><br><span class="line">   <span class="comment">// method is expected to update this render object accordingly.</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">// The cases it tries to optimize for are:</span></span><br><span class="line">   <span class="comment">//  - the old list is empty</span></span><br><span class="line">   <span class="comment">//  - the lists are identical</span></span><br><span class="line">   <span class="comment">//  - there is an insertion or removal of one or more widgets in</span></span><br><span class="line">   <span class="comment">//    only one place in the list</span></span><br><span class="line">   <span class="comment">// If a widget with a key is in both lists, it will be synced.</span></span><br><span class="line">   <span class="comment">// Widgets without keys might be synced but there is no guarantee.</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">// The general approach is to sync the entire new list backwards, as follows:</span></span><br><span class="line">   <span class="comment">// 1. Walk the lists from the top, syncing nodes, until you no longer have</span></span><br><span class="line">   <span class="comment">//    matching nodes.</span></span><br><span class="line">   <span class="comment">// 2. Walk the lists from the bottom, without syncing nodes, until you no</span></span><br><span class="line">   <span class="comment">//    longer have matching nodes. We&#x27;ll sync these nodes at the end. We</span></span><br><span class="line">   <span class="comment">//    don&#x27;t sync them now because we want to sync all the nodes in order</span></span><br><span class="line">   <span class="comment">//    from beginning to end.</span></span><br><span class="line">   <span class="comment">// At this point we narrowed the old and new lists to the point</span></span><br><span class="line">   <span class="comment">// where the nodes no longer match.</span></span><br><span class="line">   <span class="comment">// 3. Walk the narrowed part of the old list to get the list of</span></span><br><span class="line">   <span class="comment">//    keys and sync null with non-keyed items.</span></span><br><span class="line">   <span class="comment">// 4. Walk the narrowed part of the new list forwards:</span></span><br><span class="line">   <span class="comment">//     * Sync non-keyed items with null</span></span><br><span class="line">   <span class="comment">//     * Sync keyed items with the source if it exists, else with null.</span></span><br><span class="line">   <span class="comment">// 5. Walk the bottom of the list again, syncing the nodes.</span></span><br><span class="line">   <span class="comment">// 6. Sync null with any items in the list of keys that are still</span></span><br><span class="line">   <span class="comment">//    mounted.</span></span><br><span class="line">	<span class="comment">// 讲人话就是. 一个数组保存的上一帧Element，另外一个保存最新的Widget。 element持有widget，widget可以createElement。</span></span><br><span class="line">	<span class="comment">// 遍历两个数组的头尾指针。头指针为0，尾指针为newWidgets.length - 1</span></span><br><span class="line">	<span class="comment">// 1. 同时对两个数组从头遍历，如果可以复用element，也是Widget.canUpdate为true。则更新</span></span><br><span class="line">	<span class="comment">// updateChild(oldChild, newWidget, slotFor(newChildrenTop, previousChild))和头指针，并且保存复用的Element到newChildren中。直到不能匹配</span></span><br><span class="line">	<span class="comment">// 2. 再从尾部倒序遍历。Widget.canUpdate为真，则更新尾指针。直到不能匹配.</span></span><br><span class="line">	<span class="comment">// 3. 遍历Elements的中段。根据是否有key来暂时保留或者释放。key对组件性能的优化。</span></span><br><span class="line">	<span class="comment">// 4. 遍历Widgets的中段。如果widget.key 命中了第3步缓存的elemnt，否则会创建新的element。并且更新widgets的头指针</span></span><br><span class="line">	<span class="comment">// 5. 遍历尾段。更新第2步中Widget.canUpdate为真的element。</span></span><br><span class="line">	<span class="comment">// 6. 释放第3步中没有命中key的element。</span></span><br><span class="line">	<span class="comment">// 返回新的children element数组。</span></span><br><span class="line"></span><br><span class="line">   int newChildrenTop = <span class="number">0</span>;</span><br><span class="line">   int oldChildrenTop = <span class="number">0</span>;</span><br><span class="line">   int newChildrenBottom = newWidgets.length - <span class="number">1</span>;</span><br><span class="line">   int oldChildrenBottom = oldChildren.length - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">   final List&lt;Element&gt; newChildren = oldChildren.length == newWidgets.length</span><br><span class="line">       ? oldChildren</span><br><span class="line">       : List&lt;Element&gt;.filled(newWidgets.length, _NullElement.instance, <span class="attr">growable</span>: <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">   Element? previousChild;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Update the top of the list.</span></span><br><span class="line">   <span class="keyword">while</span> ((oldChildrenTop &lt;= oldChildrenBottom) &amp;&amp; (newChildrenTop &lt;= newChildrenBottom)) &#123;</span><br><span class="line">     final Element? oldChild = replaceWithNullIfForgotten(oldChildren[oldChildrenTop]);</span><br><span class="line">     final Widget newWidget = newWidgets[newChildrenTop];</span><br><span class="line">     <span class="keyword">if</span> (oldChild == <span class="literal">null</span> || !Widget.canUpdate(oldChild.widget, newWidget)) <span class="keyword">break</span>;</span><br><span class="line">     final Element newChild = updateChild(oldChild, newWidget, slotFor(newChildrenTop, previousChild))!;</span><br><span class="line">     newChildren[newChildrenTop] = newChild;</span><br><span class="line">     previousChild = newChild;</span><br><span class="line">     newChildrenTop += <span class="number">1</span>;</span><br><span class="line">     oldChildrenTop += <span class="number">1</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Scan the bottom of the list.</span></span><br><span class="line">   <span class="keyword">while</span> ((oldChildrenTop &lt;= oldChildrenBottom) &amp;&amp; (newChildrenTop &lt;= newChildrenBottom)) &#123;</span><br><span class="line">     final Element? oldChild = replaceWithNullIfForgotten(oldChildren[oldChildrenBottom]);</span><br><span class="line">     final Widget newWidget = newWidgets[newChildrenBottom];</span><br><span class="line">     <span class="keyword">if</span> (oldChild == <span class="literal">null</span> || !Widget.canUpdate(oldChild.widget, newWidget)) <span class="keyword">break</span>;</span><br><span class="line">     oldChildrenBottom -= <span class="number">1</span>;</span><br><span class="line">     newChildrenBottom -= <span class="number">1</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Scan the old children in the middle of the list.</span></span><br><span class="line">   final bool haveOldChildren = oldChildrenTop &lt;= oldChildrenBottom;</span><br><span class="line">   <span class="built_in">Map</span>&lt;Key, Element&gt;? oldKeyedChildren;</span><br><span class="line">   <span class="keyword">if</span> (haveOldChildren) &#123;</span><br><span class="line">     oldKeyedChildren = <span class="xml">&lt;Key, Element&gt;&#123;&#125;;</span></span><br><span class="line"><span class="xml">     while (oldChildrenTop &lt;= oldChildrenBottom) &#123;</span></span><br><span class="line"><span class="xml">       final Element? oldChild = replaceWithNullIfForgotten(oldChildren[oldChildrenTop]);</span></span><br><span class="line"><span class="xml">       if (oldChild != null) &#123;</span></span><br><span class="line"><span class="xml">         if (oldChild.widget.key != null)</span></span><br><span class="line"><span class="xml">           oldKeyedChildren[oldChild.widget.key!] = oldChild;</span></span><br><span class="line"><span class="xml">         else</span></span><br><span class="line"><span class="xml">           deactivateChild(oldChild);</span></span><br><span class="line"><span class="xml">       &#125;</span></span><br><span class="line"><span class="xml">       oldChildrenTop += 1;</span></span><br><span class="line"><span class="xml">     &#125;</span></span><br><span class="line"><span class="xml">   &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="xml">   // Update the middle of the list.</span></span><br><span class="line"><span class="xml">   while (newChildrenTop &lt;= newChildrenBottom) &#123;</span></span><br><span class="line"><span class="xml">     Element? oldChild;</span></span><br><span class="line"><span class="xml">     final Widget newWidget = newWidgets[newChildrenTop];</span></span><br><span class="line"><span class="xml">     if (haveOldChildren) &#123;</span></span><br><span class="line"><span class="xml">       final Key? key = newWidget.key;</span></span><br><span class="line"><span class="xml">       if (key != null) &#123;</span></span><br><span class="line"><span class="xml">         oldChild = oldKeyedChildren![key];</span></span><br><span class="line"><span class="xml">         if (oldChild != null) &#123;</span></span><br><span class="line"><span class="xml">           if (Widget.canUpdate(oldChild.widget, newWidget)) &#123;</span></span><br><span class="line"><span class="xml">             // we found a match!</span></span><br><span class="line"><span class="xml">             // remove it from oldKeyedChildren so we don&#x27;t unsync it later</span></span><br><span class="line"><span class="xml">             oldKeyedChildren.remove(key);</span></span><br><span class="line"><span class="xml">           &#125; else &#123;</span></span><br><span class="line"><span class="xml">             // Not a match, let&#x27;s pretend we didn&#x27;t see it for now.</span></span><br><span class="line"><span class="xml">             oldChild = null;</span></span><br><span class="line"><span class="xml">           &#125;</span></span><br><span class="line"><span class="xml">         &#125;</span></span><br><span class="line"><span class="xml">       &#125;</span></span><br><span class="line"><span class="xml">     &#125;</span></span><br><span class="line"><span class="xml">     final Element newChild = updateChild(oldChild, newWidget, slotFor(newChildrenTop, previousChild))!;</span></span><br><span class="line"><span class="xml">     newChildren[newChildrenTop] = newChild;</span></span><br><span class="line"><span class="xml">     previousChild = newChild;</span></span><br><span class="line"><span class="xml">     newChildrenTop += 1;</span></span><br><span class="line"><span class="xml">   &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="xml">   // We&#x27;ve scanned the whole list.</span></span><br><span class="line"><span class="xml">   assert(oldChildrenTop == oldChildrenBottom + 1);</span></span><br><span class="line"><span class="xml">   assert(newChildrenTop == newChildrenBottom + 1);</span></span><br><span class="line"><span class="xml">   assert(newWidgets.length - newChildrenTop == oldChildren.length - oldChildrenTop);</span></span><br><span class="line"><span class="xml">   newChildrenBottom = newWidgets.length - 1;</span></span><br><span class="line"><span class="xml">   oldChildrenBottom = oldChildren.length - 1;</span></span><br><span class="line"></span><br><span class="line"><span class="xml">   // Update the bottom of the list.</span></span><br><span class="line"><span class="xml">   while ((oldChildrenTop &lt;= oldChildrenBottom) &amp;&amp; (newChildrenTop &lt;= newChildrenBottom)) &#123;</span></span><br><span class="line"><span class="xml">     final Element oldChild = oldChildren[oldChildrenTop];</span></span><br><span class="line"><span class="xml">     final Widget newWidget = newWidgets[newChildrenTop];</span></span><br><span class="line"><span class="xml">     final Element newChild = updateChild(oldChild, newWidget, slotFor(newChildrenTop, previousChild))!;</span></span><br><span class="line"><span class="xml">     newChildren[newChildrenTop] = newChild;</span></span><br><span class="line"><span class="xml">     previousChild = newChild;</span></span><br><span class="line"><span class="xml">     newChildrenTop += 1;</span></span><br><span class="line"><span class="xml">     oldChildrenTop += 1;</span></span><br><span class="line"><span class="xml">   &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="xml">   // Clean up any of the remaining middle nodes from the old list.</span></span><br><span class="line"><span class="xml">   if (haveOldChildren &amp;&amp; oldKeyedChildren!.isNotEmpty) &#123;</span></span><br><span class="line"><span class="xml">     for (final Element oldChild in oldKeyedChildren.values) &#123;</span></span><br><span class="line"><span class="xml">       if (forgottenChildren == null || !forgottenChildren.contains(oldChild)) deactivateChild(oldChild);</span></span><br><span class="line"><span class="xml">     &#125;</span></span><br><span class="line"><span class="xml">   &#125;</span></span><br><span class="line"><span class="xml">   return newChildren;</span></span><br><span class="line"><span class="xml"> &#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><h3 id="GlobalKey"><a href="#GlobalKey" class="headerlink" title="GlobalKey"></a>GlobalKey</h3><p>element mount的时候,BuildOwner中Map缓存了element和key。</p>
<h3 id="Debug代码"><a href="#Debug代码" class="headerlink" title="Debug代码"></a>Debug代码</h3><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">assert(() &#123;</span><br><span class="line">	<span class="comment">// debug code</span></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;()</span><br></pre></td></tr></table></figure>
<h3 id="setState-1"><a href="#setState-1" class="headerlink" title="setState"></a>setState</h3><p>最小Widget里执行setState。</p>
<h3 id="命令模式写Flutter"><a href="#命令模式写Flutter" class="headerlink" title="命令模式写Flutter"></a>命令模式写Flutter</h3><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@override</span></span><br><span class="line">Widget build(BuildContext context) &#123;</span><br><span class="line">		AlignView center = AlignView();</span><br><span class="line">    center.alignment = Alignment.center;</span><br><span class="line"></span><br><span class="line">    ContainerView container = ContainerView();</span><br><span class="line"></span><br><span class="line">    FlexView flexView = FlexView();</span><br><span class="line">		<span class="comment">// 命令模式</span></span><br><span class="line">    flexView.direction = Axis.horizontal;</span><br><span class="line">    flexView.children.add(TextView()..text = <span class="string">&quot;你好&quot;</span>);</span><br><span class="line">    flexView.children.add(TextView()..text = textTitle);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 链式调用</span></span><br><span class="line">	  container.color(Colors.yellow).paddding(EdgeInsets.all(<span class="number">20</span>)).child = flexView;</span><br><span class="line">    center.child = container;</span><br><span class="line">    <span class="keyword">return</span> center.build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>源码</p>
  <figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">WidgetBuilder</span> </span>&#123;</span><br><span class="line">  Widget build();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ContainerView</span> <span class="keyword">extends</span> <span class="title">WidgetBuilder</span> </span>&#123;</span><br><span class="line">  WidgetBuilder? child;</span><br><span class="line"></span><br><span class="line">  Color? _color;</span><br><span class="line"></span><br><span class="line">  EdgeInsetsGeometry? _padding;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build() &#123;</span><br><span class="line">    <span class="keyword">return</span> Container(</span><br><span class="line">      child: child?.build(),</span><br><span class="line">      color: _color,</span><br><span class="line">      padding: _padding,</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ContainerView paddding(EdgeInsets padding) &#123;</span><br><span class="line">    <span class="keyword">this</span>._padding = padding;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ContainerView color(Color color) &#123;</span><br><span class="line">    <span class="keyword">this</span>._color = color;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FlexView</span> <span class="keyword">extends</span> <span class="title">WidgetBuilder</span> </span>&#123;</span><br><span class="line">  <span class="built_in">List</span>&lt;WidgetBuilder&gt; children = [];</span><br><span class="line"></span><br><span class="line">  Axis direction = Axis.horizontal;</span><br><span class="line"></span><br><span class="line">  MainAxisAlignment mainAxisAlignment = MainAxisAlignment.center;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build() &#123;</span><br><span class="line">    <span class="keyword">return</span> Flex(</span><br><span class="line">      direction: direction,</span><br><span class="line">      children: children.map((e) =&gt; e.build()).toList(),</span><br><span class="line">      mainAxisAlignment: mainAxisAlignment,</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AlignView</span> <span class="keyword">extends</span> <span class="title">WidgetBuilder</span> </span>&#123;</span><br><span class="line">  WidgetBuilder? child;</span><br><span class="line"></span><br><span class="line">  AlignmentGeometry alignment = Alignment.center;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">double?</span> widthFactor;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">double?</span> heightFactor;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build() &#123;</span><br><span class="line">    <span class="keyword">return</span> Align(</span><br><span class="line">      child: child?.build(),</span><br><span class="line">      alignment: alignment,</span><br><span class="line">      widthFactor: widthFactor,</span><br><span class="line">      heightFactor: heightFactor,</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TextView</span> <span class="keyword">extends</span> <span class="title">WidgetBuilder</span> </span>&#123;</span><br><span class="line">  <span class="built_in">String</span> text = <span class="string">&quot;&quot;</span>;</span><br><span class="line">  TextStyle? style;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build() &#123;</span><br><span class="line">    <span class="keyword">return</span> Text(</span><br><span class="line">      text,</span><br><span class="line">      style: style,</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>


                            <!-- Meta -->
                            <div class="post-meta">
                                <hr>
                                <br>
                                <div class="post-tags">
                                    
                                </div>
                                <div class="post-date">
                                    2021-07-26
                                </div>
                            </div>
                    </div>

                    <!-- Comments -->
                    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                        <!-- Disqus Comments -->


                    </div>
                </div>
            </div>
        </article>
</section>

<!-- Image viewer-->

    <!-- Custom picture view-->
    <link href="/css/viewer.min.css" rel="stylesheet" />
    <script
      src="/js/viewer.min.js"
      type="text/javascript"
      charset="utf-8"
    ></script>
    
    <script type="text/javascript">
      // set image viewer
      Viewer.setDefaults({
        zoomRatio: [0.5],
        navbar: false,
        toolbar: false,
        button: false,
        title: [2, (image, imageData) => `${image.alt}`],
        show: function() {
          this.viewer.zoomTo(0.5);
        }
      });
      var imageList = document.getElementsByTagName("img");
      Array.prototype.forEach.call(imageList, element => {
        var viewer = new Viewer(element);
      });
    </script>

    
    <!-- Scripts -->
    <script type="text/javascript">
    console.log("© zchen9 🙋 2015-" + new Date().getFullYear());
</script>
  
    <!-- Google Analytics -->
    

    <!-- Service Worker -->
    <!-- if using service worker -->

    
</body>

</html>