<!DOCTYPE html>
<html lang="zh-Hans">

<!-- Head tag -->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!--Description-->
    
        <meta name="description" content="å¼•ç”¨è®¡æ•°çš„å®ç°ä¸ä»…ä»…å¼€å…³ç¯è¿™ä¹ˆç®€å•">
    

    <!--Author-->
    
        <meta name="author" content="Leven">
    

    <!-- Title -->
    
    <title>å¼•ç”¨è®¡æ•°çš„å®ç° | Leven</title>

    <!-- Bootstrap Core CSS -->
    <link href="//cdn.bootcss.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    
<link rel="stylesheet" href="/css/style.css">


    <!-- Custom Fonts -->
    <link href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Noto+Serif:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

    <!-- jQuery -->
    <script src="//cdn.bootcss.com/jquery/2.2.1/jquery.min.js"></script>
    <!-- Bootstrap -->
    <script src="//cdn.bootcss.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
<meta name="generator" content="Hexo 5.3.0"></head>

<body>

    <!-- Content -->
    <section class="article-container">
    <!-- Back Home -->
    <a class="nav-back" href="/">
    <i class="fa fa-puzzle-piece"></i>
</a>

        <!-- Page Header -->
        <header class="intro-header">
            <div class="container">
                <div class="row">
                    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                        <div class="post-heading">
                            <h1>
                                å¼•ç”¨è®¡æ•°çš„å®ç°
                            </h1>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Post Content -->
        <article>
            <div class="container">
                <div class="row">
                    <!-- Post Main Content -->
                    <div class="post-content col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                        <p>å¼•ç”¨è®¡æ•°çš„å®ç°ä¸ä»…ä»…å¼€å…³ç¯è¿™ä¹ˆç®€å•</p>
<a id="more"></a>


<p>æœ‰æœ¬iOSå¼€å‘çš„ç»å…¸ä¹¦ç±åœ¨ä»‹ç»å¼•ç”¨è®¡æ•°çš„æ—¶å€™ï¼Œç”¨äº†åœ¨é»‘å±‹é‡Œå¼€å…³ç¯æ–¹å¼æ¥ä»‹ç»å¼•ç”¨è®¡æ•°çš„åŸç†ã€‚ä½†å®é™…ä¸Šç¨å¾®ç ”ç©¶ä¹‹åï¼Œå‘ç°å®ç°æ¯”è¿™å¤æ‚ä¸å°‘ã€‚åœ¨MRCå¹´ä»£ï¼Œæˆ‘ä»¬è¦è·å–ä¸€ä¸ªå¯¹è±¡çš„æ‰€æœ‰æƒçš„æ—¶å€™ï¼Œéœ€è¦retainï¼Œå¼•ç”¨è®¡æ•°åŠ 1ã€‚å½“ä¸å†éœ€è¦è¿™ä¸ªå¯¹è±¡çš„æ—¶å€™éœ€è¦releaseï¼Œå¼•ç”¨è®¡æ•°å‡1ã€‚åœ¨ARCå¹´ä»£ï¼Œç¼–è¯‘å™¨å’ŒRuntimeï¼Œrunloopè”åˆèµ·æ¥æ›¿æˆ‘ä»¬å®Œæˆäº†è¿™äº›ç¹ççš„æ“ä½œã€‚</p>
<h3 id="alloc"><a href="#alloc" class="headerlink" title="alloc"></a>alloc</h3><p>æˆ‘ä»¬å…ˆçœ‹çœ‹å¯¹è±¡åˆšåˆ›å»ºçš„æ—¶å€™ï¼Œå¼•ç”¨è®¡æ•°çš„åˆå§‹åŒ–ã€‚ç®€åŒ–åçš„runtime</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">static __attribute__((always_inline)) </span><br><span class="line">id</span><br><span class="line">_class_createInstanceFromZone(Class cls, size_t extraBytes, void *zone, </span><br><span class="line">                              bool cxxConstruct &#x3D; true, </span><br><span class="line">                              size_t *outAllocatedSize &#x3D; nil)</span><br><span class="line">&#123;</span><br><span class="line">    ....</span><br><span class="line">    size_t size &#x3D; cls-&gt;instanceSize(extraBytes);</span><br><span class="line">    obj &#x3D; (id)calloc(1, size);</span><br><span class="line">    obj-&gt;initIsa(cls, hasCxxDtor);</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">    return obj</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">inline void </span><br><span class="line">objc_object::initIsa(Class cls, bool indexed, bool hasCxxDtor) </span><br><span class="line">&#123; </span><br><span class="line">    assert(!isTaggedPointer()); </span><br><span class="line">    </span><br><span class="line">    if (!indexed) &#123;</span><br><span class="line">        &#x2F;&#x2F; æ²¡æœ‰å¼€å¯æŒ‡é’ˆä¼˜åŒ–ï¼Œåˆ©ç”¨æŒ‡é’ˆçš„å…¶ä»–ä½å­˜å‚¨ä¿¡æ¯ã€‚å› ä¸º64ä½çš„æŒ‡é’ˆåªæ˜¯å­˜å‚¨åœ°å€ï¼Œä¼šæœ‰å†…å­˜æµªè´¹ã€‚æ‰€ä»¥64ä½ç³»ç»Ÿè¿™ä¸ªé»˜è®¤æ˜¯å¼€å¯çš„ã€‚</span><br><span class="line">        isa.cls &#x3D; cls;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        assert(!DisableIndexedIsa);</span><br><span class="line">        isa.bits &#x3D; ISA_MAGIC_VALUE;</span><br><span class="line">        &#x2F;&#x2F; isa.magic is part of ISA_MAGIC_VALUE</span><br><span class="line">        &#x2F;&#x2F; isa.indexed is part of ISA_MAGIC_VALUE</span><br><span class="line">        isa.has_cxx_dtor &#x3D; hasCxxDtor;</span><br><span class="line">        isa.shiftcls &#x3D; (uintptr_t)cls &gt;&gt; 3; &#x2F;&#x2F; å°†classåœ°å€å­˜è¿›isaçš„æŸæ®µä½ä¸­ã€‚</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯¹è±¡åˆ›å»ºçš„æ—¶å€™ï¼Œæˆ‘ä»¬æ²¡æœ‰çœ‹è§å¯¹å¼•ç”¨è®¡æ•°æœ‰ç›¸å…³æ“ä½œã€‚éš¾é“æ­¤æ—¶è·å–retainCountä¸º0å—ï¼Ÿï¼Œä¸æ˜¯ï¼Œå…¶å®ä¸º1ã€‚å› ä¸ºretainCountçš„å®ç°æ–¹æ³•é‡Œæœ‰åˆå§‹åŠ 1çš„æ“ä½œ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">inline uintptr_t </span><br><span class="line">objc_object::rootRetainCount()</span><br><span class="line">&#123;</span><br><span class="line">    assert(!UseGC);</span><br><span class="line">    if (isTaggedPointer()) return (uintptr_t)this;</span><br><span class="line"></span><br><span class="line">    sidetable_lock();</span><br><span class="line">    isa_t bits &#x3D; LoadExclusive(&amp;isa.bits);</span><br><span class="line">    if (bits.indexed) &#123;</span><br><span class="line">        uintptr_t rc &#x3D; 1 + bits.extra_rc; &#x2F;&#x2F; å–å‡ºå¼•ç”¨è®¡æ•°ååŠ äº†1</span><br><span class="line">        if (bits.has_sidetable_rc) &#123;</span><br><span class="line">            rc +&#x3D; sidetable_getExtraRC_nolock();</span><br><span class="line">        &#125;</span><br><span class="line">        sidetable_unlock();</span><br><span class="line">        return rc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sidetable_unlock();</span><br><span class="line">    return sidetable_retainCount();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="retain"><a href="#retain" class="headerlink" title="retain"></a>retain</h3><p>å˜é‡çš„å¼•ç”¨è®¡æ•°æœ‰ä¸€éƒ¨åˆ†å­˜åœ¨isaæŒ‡é’ˆä¸­ï¼Œå½“isaæŒ‡é’ˆè®¡æ»¡çš„æ—¶å€™ï¼Œä¼šè¿ç§»ä¸€åŠåˆ°å…¨å±€çš„å¼•ç”¨è®¡æ•°side tableä¸­</p>
<p>æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹retainçš„runtimeçš„æºç </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">ALWAYS_INLINE id </span><br><span class="line">objc_object::rootRetain(bool tryRetain, bool handleOverflow)</span><br><span class="line">&#123;</span><br><span class="line">    assert(!UseGC);</span><br><span class="line">    &#x2F;&#x2F; å¦‚æœæ˜¯TaggedPointerï¼Œåˆ™ä¸ä¼šè¿›è¡Œå¼•ç”¨è®¡æ•°å¤„ç†ã€‚ç›´æ¥äº¤ç”±ç³»ç»Ÿå½“ä½œæ ˆå˜é‡é‡Šæ”¾è§„åˆ™å¤„ç†</span><br><span class="line">    if (isTaggedPointer()) return (id)this;</span><br><span class="line"></span><br><span class="line">    bool sideTableLocked &#x3D; false;</span><br><span class="line">    bool transcribeToSideTable &#x3D; false; &#x2F;&#x2F; æ˜¯å¦å°†éƒ¨åˆ†å¼•ç”¨è®¡æ•°å­˜åœ¨saidetableä¸­</span><br><span class="line"></span><br><span class="line">    isa_t oldisa;</span><br><span class="line">    isa_t newisa;</span><br><span class="line"></span><br><span class="line">    do &#123;</span><br><span class="line">        transcribeToSideTable &#x3D; false;</span><br><span class="line">        &#x2F;&#x2F; å¤‡ä»½ä¸‹isa.bits</span><br><span class="line">        oldisa &#x3D; LoadExclusive(&amp;isa.bits);</span><br><span class="line">        newisa &#x3D; oldisa;</span><br><span class="line">        &#x2F;&#x2F; å¦‚æœæ˜¯éä¼˜åŒ–çš„æŒ‡é’ˆå˜é‡ï¼Œåˆ™ç›´æ¥åœ¨å¼•ç”¨è®¡æ•°çš„side tableå¤„ç†</span><br><span class="line">        if (!newisa.indexed) goto unindexed;</span><br><span class="line">        &#x2F;&#x2F; don&#39;t check newisa.fast_rr; we already called any RR overrides</span><br><span class="line">        if (tryRetain &amp;&amp; newisa.deallocating) goto tryfail;</span><br><span class="line">        uintptr_t carry;</span><br><span class="line">        &#x2F;&#x2F; å¼•ç”¨è®¡æ•°åŠ ä¸€</span><br><span class="line">        newisa.bits &#x3D; addc(newisa.bits, RC_ONE, 0, &amp;carry);  &#x2F;&#x2F; extra_rc++</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; å¦‚æœisaä¸­çš„è®¡æ•°å·²ç»å­˜æ»¡ï¼Œåˆ™è¿ç§»ä¸€åŠåˆ°side tableä¸­</span><br><span class="line">        if (carry) &#123;</span><br><span class="line">            &#x2F;&#x2F; newisa.extra_rc++ overflowed</span><br><span class="line">            if (!handleOverflow) return rootRetain_overflow(tryRetain);</span><br><span class="line">            &#x2F;&#x2F; Leave half of the retain counts inline and </span><br><span class="line">            &#x2F;&#x2F; prepare to copy the other half to the side table.</span><br><span class="line">            if (!tryRetain &amp;&amp; !sideTableLocked) sidetable_lock();</span><br><span class="line">            sideTableLocked &#x3D; true;</span><br><span class="line">            transcribeToSideTable &#x3D; true;</span><br><span class="line">            newisa.extra_rc &#x3D; RC_HALF; &#x2F;&#x2F; åªç•™ä¸‹ä¸€åŠ</span><br><span class="line">            newisa.has_sidetable_rc &#x3D; true; &#x2F;&#x2F; æ ‡è®°åˆ©ç”¨äº†side tableæ¥è¿›è¡Œå¼•ç”¨è®¡æ•°</span><br><span class="line">        &#125;</span><br><span class="line">        &#x2F;&#x2F; åˆ·æ–°isaï¼Œå¤±è´¥äº†å†é‡æ¥</span><br><span class="line">    &#125; while (!StoreExclusive(&amp;isa.bits, oldisa.bits, newisa.bits));</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; è¿ç§»å¼•ç”¨è®¡æ•°åˆ°side tableä¸­</span><br><span class="line">    if (transcribeToSideTable) &#123;</span><br><span class="line">        &#x2F;&#x2F; Copy the other half of the retain counts to the side table.</span><br><span class="line">        sidetable_addExtraRC_nolock(RC_HALF);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (!tryRetain &amp;&amp; sideTableLocked) sidetable_unlock();</span><br><span class="line">    return (id)this;</span><br><span class="line"></span><br><span class="line"> tryfail:</span><br><span class="line">    if (!tryRetain &amp;&amp; sideTableLocked) sidetable_unlock();</span><br><span class="line">    return nil;</span><br><span class="line"></span><br><span class="line"> unindexed:</span><br><span class="line">    if (!tryRetain &amp;&amp; sideTableLocked) sidetable_unlock();</span><br><span class="line">    if (tryRetain) return sidetable_tryRetain() ? (id)this : nil;</span><br><span class="line">    else return sidetable_retain();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å¯ä»¥ç®€å•çœ‹ä¸‹SideTableçš„ç»“æ„.<br>ä»SideTablesçš„æ•°ç»„ç»“æ„ä¸­é€šè¿‡å˜é‡çš„åœ°å€è·å–åˆ°SideTableï¼Œå†ä¸€æ¬¡é€šè¿‡å˜é‡çš„åœ°å€ä»refcntsè·å–åˆ°å˜é‡çš„å¼•ç”¨è®¡æ•°ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">struct SideTable &#123;</span><br><span class="line">    spinlock_t slock;</span><br><span class="line">    RefcountMap refcnts;</span><br><span class="line">    weak_table_t weak_table;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="release"><a href="#release" class="headerlink" title="release"></a>release</h3><p>é¦–å…ˆä¼šä»isaä¸­extra_rcå‡å»1ï¼Œå¦‚æœextra_rcä¸º0ï¼Œåˆ™å°†side tableä¸­çš„å¼•ç”¨è®¡æ•°è¿ç§»RC_HALFåˆ°extra_rcï¼Œå¹¶ä¸”å‡1ã€‚å¦‚æœè¿ç§»å¤±è´¥ï¼Œæ„å‘³ç€side tableä¸­å…³äºè¿™ä¸ªå¯¹è±¡çš„å¼•ç”¨æ•°ä¸º0ï¼Œåˆ™è¿›è¡Œdeallocæ“ä½œ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line">ALWAYS_INLINE bool </span><br><span class="line">objc_object::rootRelease(bool performDealloc, bool handleUnderflow)</span><br><span class="line">&#123;</span><br><span class="line">    assert(!UseGC);</span><br><span class="line">    if (isTaggedPointer()) return false;</span><br><span class="line"></span><br><span class="line">    bool sideTableLocked &#x3D; false;</span><br><span class="line"></span><br><span class="line">    isa_t oldisa;</span><br><span class="line">    isa_t newisa;</span><br><span class="line"></span><br><span class="line"> retry:</span><br><span class="line">    do &#123;</span><br><span class="line">        oldisa &#x3D; LoadExclusive(&amp;isa.bits);</span><br><span class="line">        newisa &#x3D; oldisa;</span><br><span class="line">        if (!newisa.indexed) goto unindexed;</span><br><span class="line">        &#x2F;&#x2F; don&#39;t check newisa.fast_rr; we already called any RR overrides</span><br><span class="line">        uintptr_t carry;</span><br><span class="line">        &#x2F;&#x2F; å¼•ç”¨è®¡æ•°å‡1</span><br><span class="line">        newisa.bits &#x3D; subc(newisa.bits, RC_ONE, 0, &amp;carry);  &#x2F;&#x2F; extra_rc--</span><br><span class="line">        &#x2F;&#x2F; å¦‚æœcarry ä¸º1çš„è¯ï¼Œåˆ™ä»£è¡¨æŒ‡é’ˆé‡Œçš„å¼•ç”¨è®¡æ•°å·²ç»æ˜¯0äº†ï¼Œæ— æ³•å‡1ï¼Œåˆ™åˆ°side tableä¸­è¿ç§»RC_HALFä¸ªå¼•ç”¨è®¡æ•°</span><br><span class="line">        if (carry) goto underflow;</span><br><span class="line">    &#125; while (!StoreReleaseExclusive(&amp;isa.bits, oldisa.bits, newisa.bits));</span><br><span class="line"></span><br><span class="line">    if (sideTableLocked) sidetable_unlock();</span><br><span class="line">    return false;</span><br><span class="line"></span><br><span class="line"> underflow:</span><br><span class="line">    &#x2F;&#x2F; newisa.extra_rc-- underflowed: borrow from side table or deallocate</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; abandon newisa to undo the decrement</span><br><span class="line">    newisa &#x3D; oldisa;</span><br><span class="line">    &#x2F;&#x2F; ä½¿ç”¨äº†side tableå¼•ç”¨è®¡æ•°</span><br><span class="line">    if (newisa.has_sidetable_rc) &#123;</span><br><span class="line">        if (!handleUnderflow) &#123;</span><br><span class="line">            return rootRelease_underflow(performDealloc);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; Transfer retain count from side table to inline storage.</span><br><span class="line"></span><br><span class="line">        if (!sideTableLocked) &#123;</span><br><span class="line">            sidetable_lock();</span><br><span class="line">            sideTableLocked &#x3D; true;</span><br><span class="line">            if (!isa.indexed) &#123;</span><br><span class="line">                &#x2F;&#x2F; Lost a race vs the indexed -&gt; not indexed transition</span><br><span class="line">                &#x2F;&#x2F; before we got the side table lock. Stop now to avoid </span><br><span class="line">                &#x2F;&#x2F; breaking the safety checks in the sidetable ExtraRC code.</span><br><span class="line">                goto unindexed;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; Try to remove some retain counts from the side table.   </span><br><span class="line">        &#x2F;&#x2F; ä»side tableä¸­å€Ÿå¼•ç”¨è®¡æ•°ä¸ªæ•°ï¼Œå¦‚æœä¸å­˜åœ¨è¿™ä¸ªå˜é‡çš„å¼•ç”¨è®¡æ•°æˆ–è€…å¼•ç”¨è®¡æ•°ä¸º0äº†ï¼Œåˆ™borrwoedä¸º0ï¼Œå¦åˆ™ä¸º RC_HALF    </span><br><span class="line">        size_t borrowed &#x3D; sidetable_subExtraRC_nolock(RC_HALF);</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; To avoid races, has_sidetable_rc must remain set </span><br><span class="line">        &#x2F;&#x2F; even if the side table count is now zero.</span><br><span class="line">        &#x2F;&#x2F; è¿˜æœ‰å¼•ç”¨è®¡æ•°å¯ä»¥å‡1ï¼Œå¦åˆ™åé¢ä¼šèµ°åˆ°dealloc</span><br><span class="line">        if (borrowed &gt; 0) &#123;</span><br><span class="line">            &#x2F;&#x2F; Side table retain count decreased.</span><br><span class="line">            &#x2F;&#x2F; Try to add them to the inline count.</span><br><span class="line">            &#x2F;&#x2F; åšå‡ä¸€æ“ä½œåï¼Œä¿å­˜åˆ°isaä¸­</span><br><span class="line">            newisa.extra_rc &#x3D; borrowed - 1;  &#x2F;&#x2F; redo the original decrement too</span><br><span class="line">            &#x2F;&#x2F; åˆ·æ–°isa</span><br><span class="line">            bool stored &#x3D; StoreExclusive(&amp;isa.bits, oldisa.bits, newisa.bits);</span><br><span class="line">            &#x2F;&#x2F; åˆ·æ–°å¤±è´¥é‡è¯•</span><br><span class="line">            if (!stored) &#123;</span><br><span class="line">                &#x2F;&#x2F; Inline update failed. </span><br><span class="line">                &#x2F;&#x2F; Try it again right now. This prevents livelock on LL&#x2F;SC </span><br><span class="line">                &#x2F;&#x2F; architectures where the side table access itself may have </span><br><span class="line">                &#x2F;&#x2F; dropped the reservation.</span><br><span class="line">                isa_t oldisa2 &#x3D; LoadExclusive(&amp;isa.bits);</span><br><span class="line">                isa_t newisa2 &#x3D; oldisa2;</span><br><span class="line">                if (newisa2.indexed) &#123;</span><br><span class="line">                    uintptr_t overflow;</span><br><span class="line">                    newisa2.bits &#x3D; </span><br><span class="line">                        addc(newisa2.bits, RC_ONE * (borrowed-1), 0, &amp;overflow);</span><br><span class="line">                    if (!overflow) &#123;</span><br><span class="line">                        stored &#x3D; StoreReleaseExclusive(&amp;isa.bits, oldisa2.bits, </span><br><span class="line">                                                       newisa2.bits);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (!stored) &#123;</span><br><span class="line">                &#x2F;&#x2F; Inline update failed.</span><br><span class="line">                &#x2F;&#x2F; Put the retains back in the side table.</span><br><span class="line">                sidetable_addExtraRC_nolock(borrowed);</span><br><span class="line">                goto retry;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            &#x2F;&#x2F; Decrement successful after borrowing from side table.</span><br><span class="line">            &#x2F;&#x2F; This decrement cannot be the deallocating decrement - the side </span><br><span class="line">            &#x2F;&#x2F; table lock and has_sidetable_rc bit ensure that if everyone </span><br><span class="line">            &#x2F;&#x2F; else tried to -release while we worked, the last one would block.</span><br><span class="line">            sidetable_unlock();</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123;</span><br><span class="line">            &#x2F;&#x2F; Side table is empty after all. Fall-through to the dealloc path.</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Really deallocate.</span><br><span class="line"></span><br><span class="line">    if (sideTableLocked) sidetable_unlock();</span><br><span class="line"></span><br><span class="line">    if (newisa.deallocating) &#123;</span><br><span class="line">        return overrelease_error();</span><br><span class="line">    &#125;</span><br><span class="line">    newisa.deallocating &#x3D; true;</span><br><span class="line">    if (!StoreExclusive(&amp;isa.bits, oldisa.bits, newisa.bits)) goto retry;</span><br><span class="line">    __sync_synchronize();</span><br><span class="line">    &#x2F;&#x2F; å‘ç°æ²¡æœ‰å¼•ç”¨è®¡æ•°å¯ä»¥å‡1äº†ï¼Œåˆ™è¿›è¡Œdeallocæ“ä½œ</span><br><span class="line">    if (performDealloc) &#123;</span><br><span class="line">        ((void(*)(objc_object *, SEL))objc_msgSend)(this, SEL_dealloc);</span><br><span class="line">    &#125;</span><br><span class="line">    return true;</span><br><span class="line"></span><br><span class="line"> unindexed:</span><br><span class="line">    if (sideTableLocked) sidetable_unlock();</span><br><span class="line">    return sidetable_release(performDealloc);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>ä¹‹å‰å‘ç°å˜é‡relaseä¹‹å‰ï¼Œå¼•ç”¨è®¡æ•°è¿˜æ˜¯1ï¼Œä»¥ä¸ºæ˜¯å‘ç°è¦deallocçš„æ—¶å€™ï¼Œä¸å†å¤šæ­¤ä¸€ä¸¾çš„å»ä¿®æ”¹å¼•ç”¨è®¡æ•°ï¼ˆ<a target="_blank" rel="noopener" href="https://blog.devtang.com/2016/07/30/ios-memory-management/">å”å·§æ–‡ç« </a>ï¼‰ã€‚ç ”ç©¶æºç çœ‹ä¸‹å…¶å®å†…å­˜ä¸­çš„å¼•ç”¨è®¡æ•°å·²ç»ä¸º0äº†ï¼Œåªæ˜¯å½“ä½ å»è·å–retainCountçš„æ—¶å€™ï¼Œé»˜è®¤ä¼šåŠ ä¸€ä¸ª1.</p>


                            <!-- Meta -->
                            <div class="post-meta">
                                <hr>
                                <br>
                                <div class="post-tags">
                                    
                                        

<a href="/tags/iOSå†…å­˜ç®¡ç†/">#iOSå†…å­˜ç®¡ç†</a>


                                            
                                </div>
                                <div class="post-date">
                                    2021-03-11
                                </div>
                            </div>
                    </div>

                    <!-- Comments -->
                    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                        <!-- Disqus Comments -->


                    </div>
                </div>
            </div>
        </article>
</section>

<!-- Image viewer-->

    <!-- Custom picture view-->
    <link href="/css/viewer.min.css" rel="stylesheet" />
    <script
      src="/js/viewer.min.js"
      type="text/javascript"
      charset="utf-8"
    ></script>
    
    <script type="text/javascript">
      // set image viewer
      Viewer.setDefaults({
        zoomRatio: [0.5],
        navbar: false,
        toolbar: false,
        button: false,
        title: [2, (image, imageData) => `${image.alt}`],
        show: function() {
          this.viewer.zoomTo(0.5);
        }
      });
      var imageList = document.getElementsByTagName("img");
      Array.prototype.forEach.call(imageList, element => {
        var viewer = new Viewer(element);
      });
    </script>

    
    <!-- Scripts -->
    <script type="text/javascript">
    console.log("Â© zchen9 ğŸ™‹ 2015-" + new Date().getFullYear());
</script>
  
    <!-- Google Analytics -->
    

    <!-- Service Worker -->
    <!-- if using service worker -->

    
</body>

</html>