<!DOCTYPE html>
<html lang="zh-Hans">

<!-- Head tag -->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!--Description-->
    
        <meta name="description" content="å½“Kingfisherä»æœ¬åœ°æˆ–è€…serveråŠ è½½å›¾ç‰‡çš„æ—¶å€™ï¼Œé¦–å…ˆä¼šå°†æºå°è£…ä¸ºResourceæˆ–è€…Providerã€‚å¦‚æœæ˜¯serverçš„å›¾ç‰‡ï¼Œé¦–å…ˆä¼šåˆ¤æ–­æ˜¯å¦åœ¨MemoryCacheä¸­ï¼Œå¦‚æœåœ¨å¹¶ä¸”æ²¡æœ‰è¿‡æœŸï¼Œåˆ™ç›´æ¥è¿”å›ï¼Œå¹¶ä¸”æ›´æ–°è¿‡æœŸæ—¶é—´â€¦">
    

    <!--Author-->
    
        <meta name="author" content="Leven">
    

    <!-- Title -->
    
    <title>æ‰‹æ•²æºç -Kingfisher | Leven</title>

    <!-- Bootstrap Core CSS -->
    <link href="//cdn.bootcss.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    
<link rel="stylesheet" href="/css/style.css">


    <!-- Custom Fonts -->
    <link href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Noto+Serif:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

    <!-- jQuery -->
    <script src="//cdn.bootcss.com/jquery/2.2.1/jquery.min.js"></script>
    <!-- Bootstrap -->
    <script src="//cdn.bootcss.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
<meta name="generator" content="Hexo 5.3.0"></head>

<body>

    <!-- Content -->
    <section class="article-container">
    <!-- Back Home -->
    <a class="nav-back" href="/">
    <i class="fa fa-puzzle-piece"></i>
</a>

        <!-- Page Header -->
        <header class="intro-header">
            <div class="container">
                <div class="row">
                    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                        <div class="post-heading">
                            <h1>
                                æ‰‹æ•²æºç -Kingfisher
                            </h1>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Post Content -->
        <article>
            <div class="container">
                <div class="row">
                    <!-- Post Main Content -->
                    <div class="post-content col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                        <p>å½“Kingfisherä»æœ¬åœ°æˆ–è€…serveråŠ è½½å›¾ç‰‡çš„æ—¶å€™ï¼Œé¦–å…ˆä¼šå°†æºå°è£…ä¸ºResourceæˆ–è€…Providerã€‚å¦‚æœæ˜¯serverçš„å›¾ç‰‡ï¼Œé¦–å…ˆä¼šåˆ¤æ–­æ˜¯å¦åœ¨MemoryCacheä¸­ï¼Œå¦‚æœåœ¨å¹¶ä¸”æ²¡æœ‰è¿‡æœŸï¼Œåˆ™ç›´æ¥è¿”å›ï¼Œå¹¶ä¸”æ›´æ–°è¿‡æœŸæ—¶é—´â€¦</p>
<a id="more"></a>

<h1 id="Kingfisherè§£æ"><a href="#Kingfisherè§£æ" class="headerlink" title="Kingfisherè§£æ"></a>Kingfisherè§£æ</h1><h2 id="Cache"><a href="#Cache" class="headerlink" title="Cache"></a>Cache</h2><h3 id="1-Storage-swift"><a href="#1-Storage-swift" class="headerlink" title="1. Storage.swift"></a>1. Storage.swift</h3><p><code>TimeConstants</code> <code>struct</code> å®šä¹‰äº†ç§’åˆ†æ—¶å¤©<br>    <code>StorageExpiration</code> <code>enum</code>ç±»å‹ï¼Œç”¨æ¥å®šä¹‰ç¼“å­˜è¿‡æœŸæ—¶é—´ï¼Œ<br>    <code>ExpirationExtending</code> <code>enum</code>ç±»å‹ï¼Œç”¨æ¥å®šä¹‰å¯¹ç¼“å­˜å…ƒç´ çš„å»¶æœŸã€‚ä¸€èˆ¬è·å–åˆ°ç¼“å­˜å…ƒç´ åï¼Œä¼šå¯¹è¯¥å…ƒç´ çš„è¿‡æœŸæ—¶é—´è¿›è¡Œå»¶æœŸ<br>    <code>CacheCostCalcuable</code> <code>Protocol</code> ç±»å‹ã€‚åˆæ¥å®šä¹‰å…ƒç´ æ‰€å çš„ç¼“å­˜å¤§å°<br>    <code>DataTransformable</code> <code>Protocol</code>,ç”¨æ¥å®šä¹‰<br>    å¯¹è±¡è½¬ä¸ºDataï¼Œä»¥åŠDataè½¬ä¸ºå¯¹è±¡çš„æ¥å£å®šä¹‰ã€‚</p>
<h3 id="2-MemoryStorage-swift"><a href="#2-MemoryStorage-swift" class="headerlink" title="2. MemoryStorage.swift"></a>2. MemoryStorage.swift</h3><p><code>MemoryStorage</code>å®šä¹‰ä¸º<code>enum</code>ç±»å‹çš„åŸå› æ˜¯å› ä¸º<code>This is a namespace for the memory storage types</code>,å†…éƒ¨æœ‰<code>Backend&lt;T:CacheCostCalcuable&gt;</code>ç±»å‹ã€‚å†…éƒ¨ç¼“å­˜å¯¹è±¡ä½¿ç”¨<code>NSCache</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">let storage &#x3D; NSCache&lt;NSString, StorageObject&lt;T&gt;&gt;()</span><br></pre></td></tr></table></figure>
<p>ç¼“å­˜çš„é…ç½®ä¿¡æ¯ç”±å®šä¹‰åœ¨<code>MemoryStorage</code> extensioné‡Œå®šä¹‰çš„å†…éƒ¨struct <code>Config</code>å®šä¹‰</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">extension MemoryStorage &#123;</span><br><span class="line">	var totalCostLimit: Int</span><br><span class="line">	var countLimit: Int &#x3D; .max</span><br><span class="line">	var expiration: StorageExpiration &#x3D; .second(300)</span><br><span class="line">	var cleanInterval: TimeIOnterval &#x3D; 120;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å†…å­˜ç¼“å­˜é»˜è®¤300ç§’åè¿‡æœŸï¼Œé»˜è®¤120ç§’æ¸…ç†ä¸€æ¬¡è¿‡æœŸç¼“å­˜ã€‚çœŸæ­£ç¼“å­˜åœ¨Cacheçš„å…ƒç´ æ˜¯æœ‰StorageObjectåŒ…è£¹ã€‚ç”±äºNSCacheæ— æ³•çŸ¥é“å…·ä½“ç¼“å­˜çš„keys.å› æ­¤Backendå†…ä¼šæœ‰<code>var keys = Set&lt;String&gt;()</code> æ¥è®°å½•ç¼“å­˜çš„Keys<br>ç¼“å­˜çš„çš„æ¥å£ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">func store(value: T, forKey key: String, expiration: StorageExpiration? &#x3D; nil) throws</span><br></pre></td></tr></table></figure>
<p>é¦–å…ˆä¼šé€šè¿‡NSLockåŠ é”å¦‚æœexpiration.isExpired ä¸ºtrueï¼Œä¼šç›´æ¥æ”¾å¼ƒç¼“å­˜ã€‚å°†valueå°è£…ä¸º<code>StorageObject</code>,ç„¶åç¼“å­˜</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">storage.setObject(object, forKey: key as NSString, cost: value.cacheCost)</span><br><span class="line">	keys.insert(key)</span><br></pre></td></tr></table></figure>
<p>è·å–çš„æ¥å£ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">func value(forKey key: String, extendingExpiration: ExpirationExtending &#x3D; .cacheTime) -&gt; T?</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡<code>objectForKey</code>è·å–åˆ°å…ƒç´ ã€‚å¦‚æœ<code>expired</code> ä¼šè¿”å›nilã€‚å¦‚æœæ²¡æœ‰è¿‡æœŸã€‚åˆ™ä¼šå»¶é•¿è¿‡æœŸæ—¶é—´ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">object.extendExpiration(extendingExpiration)</span><br></pre></td></tr></table></figure>

<h3 id="3-DiskStorage-swift"><a href="#3-DiskStorage-swift" class="headerlink" title="3. DiskStorage.swift"></a>3. DiskStorage.swift</h3><p>å’Œ<code>MemoryStorage.swift</code>ç±»ä¼¼ã€‚ä¸åŒçš„æ˜¯ç¼“å­˜çš„å¯¹è±¡å¿…é¡»éµå¾ª <code>DataTransformable</code>åè®®</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public class Backend&lt;T: DataTransformable&gt;</span><br></pre></td></tr></table></figure>

<p>å¦å¤–è·å–åˆ°ç£ç›˜çš„å¯¹è±¡åï¼Œå¯¹ç¼“å­˜å¯¹è±¡çš„è¿‡æœŸæ—¶é—´æ›´é«˜æ“ä½œæ”¾åœ¨ä¸€ä¸ªç©¿è¡Œé˜Ÿåˆ—å¼‚æ­¥æ‰§è¡Œ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">do &#123;</span><br><span class="line">    let data &#x3D; try Data(contentsOf: fileURL)</span><br><span class="line">    let obj &#x3D; try T.fromData(data)</span><br><span class="line">    metaChangingQueue.async &#123;</span><br><span class="line">        meta.extendExpiration(with: fileManager)</span><br><span class="line">    &#125;</span><br><span class="line">    return obj</span><br><span class="line">&#125; catch &#123;</span><br><span class="line">    throw KingfisherError.cacheError(reason: .cannotLoadDataFromDisk(url: fileURL, error: error))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç¼“å­˜çš„æ¥å£:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">func store(value: T, forKey key: String,expiration: StorageExpiration? &#x3D; nil)</span><br></pre></td></tr></table></figure>
<p>å¦‚æœ<code>expiration.expired</code>ä¸ºtrueï¼Œåˆ™ç›´æ¥returnï¼Œå¦åˆ™å°† valueè½¬ä¸ºDataï¼Œç”±keyè·å–åˆ°fileURLï¼Œå¹¶ä¸”é…ç½®åˆ°file attributeã€‚ç„¶ååˆ›å»ºæ–‡ä»¶</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">let attributes:[FileAttributeKey : Any] &#x3D; [</span><br><span class="line">    &#x2F;&#x2F; The last access date</span><br><span class="line">    .creationDate: now.filterAttributeDate,</span><br><span class="line">    &#x2F;&#x2F; The estimated expiration date.</span><br><span class="line">    .modificationDate: expiration.estimatedExpirationSinceNow.filterAttributeDate</span><br><span class="line">]</span><br><span class="line">config.fileManager.createFile(atPath: fileURL.path, contents: data, attributes: attributes)</span><br></pre></td></tr></table></figure>

<p>è·å–çš„æ¥å£:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">func value(forKey key: String, referenceDate: Date, actuallyLoad: Bool) throws -&gt; T?</span><br></pre></td></tr></table></figure>
<p>ç”±keyè·å–åˆ°fileURLï¼Œç„¶åå°è£…ä¸º FileMetaå¯¹è±¡ã€‚è¿™ä¸ªå¯¹è±¡å°è£…äº†æ–‡ä»¶attributeçš„ä¿¡æ¯ï¼Œå¦‚æœå¯¹è±¡è¿‡æœŸï¼Œåˆ™ä¸¢å¼ƒï¼Œå¦åˆ™è·å–åˆ°Dataã€‚</p>
<h3 id="4-CacheSerializer-swift"><a href="#4-CacheSerializer-swift" class="headerlink" title="4. CacheSerializer.swift"></a>4. CacheSerializer.swift</h3><p>è¿™ä¸ªæ–‡ä»¶ä¸»è¦å®šä¹‰äº†å„ç±»imageç±»å‹ä¸dataçš„äº’è½¬æ¥å£ï¼Œå®é™…ä¸Šçš„åºåˆ—åŒ–æ“ä½œåœ¨KingfisherWrapperçš„extensioné‡Œ</p>
<h3 id="5-ImageCache-swift"><a href="#5-ImageCache-swift" class="headerlink" title="5. ImageCache.swift"></a>5. ImageCache.swift</h3><p>ç¼“å­˜çš„ä¸»è¦ç®¡ç†ç±»ï¼ŒåŒ…å«äº†ç¡¬ç›˜å’Œå†…å­˜ç¼“å­˜ï¼Œå’Œä¸€ä¸ªä¸²è¡Œé˜Ÿåˆ—ç¼“å­˜çš„ç»“æœé€šè¿‡<code>ImageCacheResult</code>è¿”å›</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public enum ImageCacheResult &#123;</span><br><span class="line">    case disk(Image)</span><br><span class="line">    case memory(Image)</span><br><span class="line">    case none</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç¼“å­˜çš„æ—¶å€™å…ˆç¼“å­˜åœ¨memoryä¸­ï¼Œåç»­ä¼šé€‰æ‹©é»˜è®¤å­˜åœ¨ç¡¬ç›˜ä¸­ï¼Œå­˜ç¡¬ç›˜çš„æ“ä½œåœ¨å¼‚æ­¥ä¸²è¡Œé˜Ÿåˆ—ä¸­è¿›è¡Œã€‚<br>åºåˆ—åŒ–ï¼Œè¿‡æœŸæ—¶é—´ï¼Œå›è°ƒçš„é˜Ÿåˆ—éƒ½åœ¨<code>KingfisherParsedOptionsInfo</code>è¿™ä¸ªç±»ä¼¼å°å®å½“çš„å¯¹è±¡ä¸­ã€‚<br>å½“Appè¿›å…¥åˆ°åå°çš„ï¼Œä¼šå¼‚æ­¥å¼€å¯ä¸€ä¸ªbackgroundTask</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">var backgroundTask: UIBackgroundTaskIdentifier!</span><br><span class="line">backgroundTask &#x3D; sharedApplication.beginBackgroundTask(expirationHandler: &#123;</span><br><span class="line">    endBackgroundTask(&amp;backgroundTask!)</span><br><span class="line">&#125;)</span><br><span class="line">cleanExpiredDiskCache &#123;</span><br><span class="line">    endBackgroundTask(&amp;backgroundTask)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>èƒŒåä¼šç§»é™¤è¿‡æœŸçš„ç¼“å­˜ï¼Œä»¥åŠè¶…å‡ºç¼“å­˜é™åˆ¶çš„ç¡¬ç›˜ç¼“å­˜ã€‚è¿™é‡Œä¼šå…ˆè·å–æ‰€æœ‰ç¡¬ç›˜ç¼“å­˜å¯¹è±¡çš„URLï¼ŒcompactMapä¸ºFileMetaå¯¹è±¡ï¼Œå¹¶ä¸”æ ¹æ®æœ€åè·å–æ—¥æœŸæ’åºã€‚ç„¶åéå†è¿™äº›å¯¹è±¡ï¼Œå¯¹æ¯ä¸ªfileSizeç›¸åŠ ï¼Œåç»­å¯¹è¶…å‡ºsizeLimitçš„Filemetaå¯¹è±¡è¿›è¡Œç§»é™¤æ“ä½œã€‚</p>
<h2 id="Networking"><a href="#Networking" class="headerlink" title="Networking"></a>Networking</h2><h3 id="1-ImageDownloader-swift"><a href="#1-ImageDownloader-swift" class="headerlink" title="1.ImageDownloader.swift"></a>1.ImageDownloader.swift</h3><p>è¿™æ˜¯ä¸»è¦çš„æ ¸å¿ƒæ–‡ä»¶ï¼<br>å…ˆè¯´ä¸‹Delegateæ–‡ä»¶ï¼Œè¿™ä¸ªæ–‡ä»¶ä¸­Delegateç±»å‹ä¸»è¦æ˜¯ç”¨æ¥æœ‰æ•ˆé˜²æ­¢å¾ªç¯å¼•ç”¨çš„ã€‚å¦‚æœä¸€ä¸ªblocké‡Œéœ€è¦å¤–å±‚çš„selfï¼Œå¯ä»¥å°†blockå°è£…æˆDelegateå¯¹è±¡ã€‚Delegateè‡ªåŠ¨å¼±æŒæœ‰äº†selfï¼Œå¹¶åœ¨blockçš„æ–¹æ³•å®ç°é‡Œå°†selfè¿”å›ã€‚è€Œä¸éœ€è¦åœ¨å¤–å±‚æ‰‹åŠ¨weak selfã€‚ä¸‹é¢æœ‰å¾ˆå¥½çš„å®è·µ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">let onCompleted &#x3D; completionHandler.map &#123;</span><br><span class="line">    block -&gt; Delegate&lt;Result&lt;ImageLoadingResult, KingfisherError&gt;, Void&gt; in</span><br><span class="line">    let delegate &#x3D; Delegate&lt;Result&lt;ImageLoadingResult, KingfisherError&gt;, Void&gt;()</span><br><span class="line">        delegate.delegate(on: self) &#123; (self, callback) in</span><br><span class="line">            block(callback)</span><br><span class="line">        &#125;</span><br><span class="line">    return delegate</span><br><span class="line">                        </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sessionTask.onTaskDone.delegate(on: self) &#123; (self, done) in</span><br><span class="line">    let (result, callbacks) &#x3D; done</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¯ä¸ªè¯·æ±‚éƒ½ä¼šç”Ÿæˆä¸€ä¸ªcallbackå¯¹è±¡</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">let callbak &#x3D; SessionDataTask.TaskCallback(</span><br><span class="line">    onCompleted: onCompleted, options: options</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>ä½†æ˜¯ç›¸åŒurlçš„è¯·æ±‚åªä¼šç”Ÿæˆä¸€ä¸ª<code>DownloadTask</code>ã€‚è¿™ä¸ªè¯·æ±‚çš„callbackä¿å­˜åœ¨<code>sessionDelegate</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">let downloadTask: DownloadTask</span><br><span class="line">    if let existingTask &#x3D; sessionDelegate.task(for: url) &#123;</span><br><span class="line">        downloadTask &#x3D; sessionDelegate.append(existingTask, url: url, callback: callbak)</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        let sessionDataTask &#x3D; session.dataTask(with: request)</span><br><span class="line">        sessionDataTask.priority &#x3D; options.downloadPriority</span><br><span class="line">        downloadTask &#x3D; sessionDelegate.add(sessionDataTask, url: url, callback: callbak)</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><code>sessionDelegate</code>å°†æ–°ç”Ÿæˆ<code>URLSessionDataTask</code>å°è£…ä¸ºä¸º<code>DownloadTask</code>ï¼Œå¹¶ä¸”ä»¥urlä¸ºkeyä¿å­˜åœ¨<code>sessionDelegate</code>çš„tasksé‡Œï¼ŒsessionDelegateéµå¾ªäº†URLSessionDelegateåè®®ï¼Œåœ¨åè®®æ–¹æ³•é‡Œæ ¹æ® urlè·å–åˆ°ç›¸åº”çš„taskã€‚</p>
<p>è¿™ä¸­é—´çš„callbackï¼Œresultï¼ŒcompletionBlcokä»¥åŠoptionsçš„ä¼ è¾“å‡å°è£…åœ¨äº†<code>SessionDataTask.TaskCallback</code>ä¸­</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">struct TaskCallback &#123;</span><br><span class="line">        let onCompleted: Delegate&lt;Result&lt;ImageLoadingResult, KingfisherError&gt;, Void&gt;?</span><br><span class="line">        let options: KingfisherParsedOptionsInfo</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>åŒä¸€urlè¯·æ±‚å…¬ç”¨ä¸€ä¸ª<code>SessionDataTask</code> å›è°ƒä»¥æ•°ç»„çš„å½¢å¼ä¿å­˜åœ¨taskä¸­</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">private var callbackStore &#x3D; [CancelToken: TaskCallback]()</span><br></pre></td></tr></table></figure>

<h2 id="Kingfisher"><a href="#Kingfisher" class="headerlink" title="Kingfisher"></a>Kingfisher</h2><h3 id="1-Kingfisher"><a href="#1-Kingfisher" class="headerlink" title="1. Kingfisher"></a>1. Kingfisher</h3><p>å†…éƒ¨çš„KingfisherCompatibleValueå’ŒKingfisherCompatibleèµ·çš„æ˜¯ä¸€ä¸ªnamespaceçš„ä½œç”¨ã€‚ä¾‹å¦‚ç»™Stringæ‹“å±•ä¸€ä¸ªæ–¹æ³•ï¼Œå¦‚æœextension stringçš„è¯ï¼Œæ‰€æœ‰çš„Stringéƒ½å¯ä»¥string.methodï¼Œä½†æ˜¯é€šè¿‡å¦‚ä¸‹æ–¹æ³•ï¼Œåªèƒ½string.kf.methodè°ƒç”¨</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">extension String: KingfisherCompatibleValue &#123; &#125;</span><br><span class="line">extension KingfisherWrapper where Base &#x3D;&#x3D; String &#123;</span><br><span class="line">    var md5: String &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-KingfisherOptionsInfo"><a href="#2-KingfisherOptionsInfo" class="headerlink" title="2. KingfisherOptionsInfo"></a>2. KingfisherOptionsInfo</h3><p>è¿™æ˜¯ä¸€ä¸ªæ¯”è¾ƒé‡è¦çš„ç±»å‹ã€‚æ¡†æ¶å†…éƒ¨çš„å›è°ƒï¼Œå‚æ•°ä¼ é€’ï¼Œå…¶å®éƒ½å€Ÿç”¨äº†è¿™ä¸ªç±»ã€‚</p>
<h2 id="é‡è¦æ–‡ä»¶"><a href="#é‡è¦æ–‡ä»¶" class="headerlink" title="é‡è¦æ–‡ä»¶"></a>é‡è¦æ–‡ä»¶</h2><p>æˆ‘çœ‹æ¥æ¯”è¾ƒæœ‰æ„æ€çš„å‡ ä¸ªæ–‡ä»¶ï¼ŒDelegateï¼ŒKingfisherï¼Œ Downloaderï¼ŒSessionDelegateï¼ŒKingfisherOptionsInfoã€‚</p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>å½“Kingfisherä»æœ¬åœ°æˆ–è€…serveråŠ è½½å›¾ç‰‡çš„æ—¶å€™ï¼Œé¦–å…ˆä¼šå°†æºå°è£…ä¸ºResourceæˆ–è€…Providerã€‚å¦‚æœæ˜¯serverçš„å›¾ç‰‡ï¼Œé¦–å…ˆä¼šåˆ¤æ–­æ˜¯å¦åœ¨MemoryCacheä¸­ï¼Œå¦‚æœåœ¨å¹¶ä¸”æ²¡æœ‰è¿‡æœŸï¼Œåˆ™ç›´æ¥è¿”å›ï¼Œå¹¶ä¸”æ›´æ–°è¿‡æœŸæ—¶é—´ã€‚å¦‚æœæ²¡æœ‰åœ¨MemoryCacheä¸­ï¼Œåˆ™åˆ¤æ–­æ˜¯å¦åœ¨DiskCacheä¸­ï¼Œå¦‚æœæœ‰å¹¶ä¸”æ²¡æœ‰è¿‡æœŸï¼Œåˆ™è¿”å›åŒæ—¶å¡åˆ°MemoryCacheä¸­ã€‚å¦‚æœç¼“å­˜ä¸­éƒ½æ²¡æœ‰ï¼Œåˆ™ä¼šç”ŸæˆRequestï¼Œå¹¶ä¸”æ ¹æ®optionsé‡Œçš„modifierï¼Œå†³å®šæ˜¯å¦modifier requestã€‚å°†complete closureå°è£…ä¸ºDelegateå¯¹è±¡ï¼Œ å¼±æŒæœ‰Downloaderã€‚å°†optionså’Œcompletion delegateã€‚å°è£…ä¸ºSessionDataTask.TaskCallBackå¯¹è±¡callbackï¼ŒsessionDelegateæ ¹æ®urlåˆ¤æ–­æ˜¯å¦å·²ç»æœ‰DownloadTask,å¦‚æœæœ‰ï¼Œåˆ™ç›´æ¥å°†callbackæ·»åŠ åˆ°downloadTaskçš„callbackStoreä¸­ã€‚å¦‚æœæ²¡æœ‰DownloadTaskï¼Œåˆ™ç”±sessionæ ¹æ®requestç”ŸæˆURLSessionDataTaskï¼Œå†ç”±sessionDelegateæ ¹æ®URLSessionDataTaskï¼Œå’Œcallbackç”ŸæˆDownloadTaskï¼ŒsessionDelegateæŒæœ‰DownloadTaskï¼Œä»¥urlä¸ºkeyã€‚ç„¶ådownloadTask.resume å¼€å¯ä¸‹è½½ã€‚<br>URLSessionDelegateçš„å›è°ƒåœ¨SessionDelegateä¸­ï¼Œåœ¨å›è°ƒæ–¹æ³•é‡Œï¼Œä¼šæ ¹æ®urlè·å–åˆ°å¯¹åº”çš„downloadTaskã€‚downloadTaskæŒæœ‰optionsï¼Œå¯ä»¥è¿›è¡Œprogressï¼ŒredirectHandlerå›è°ƒã€‚ç½‘ç»œä¸‹è½½å›¾ç‰‡æˆåŠŸåï¼Œä¼šåˆ©ç”¨processoræ ¹æ®optionså¯¹å›¾ç‰‡è¿›è¡Œå¤„ç†ç¼©å°ï¼Œåè½¬ç­‰å¤„ç†ã€‚å¤„ç†å®Œæ¯•ä¼šåœ¨KingfisherManagerå±‚æ”¶åˆ°å›è°ƒï¼Œå¯¹å›¾ç‰‡è¿›è¡Œç¼“å­˜ä¹‹åï¼Œè¿”å›ç»™ä¸šåŠ¡å±‚ã€‚</p>


                            <!-- Meta -->
                            <div class="post-meta">
                                <hr>
                                <br>
                                <div class="post-tags">
                                    
                                        

<a href="/tags/æºç /">#æºç </a>


                                            
                                </div>
                                <div class="post-date">
                                    2020-03-24
                                </div>
                            </div>
                    </div>

                    <!-- Comments -->
                    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                        <!-- Disqus Comments -->


                    </div>
                </div>
            </div>
        </article>
</section>

<!-- Image viewer-->

    <!-- Custom picture view-->
    <link href="/css/viewer.min.css" rel="stylesheet" />
    <script
      src="/js/viewer.min.js"
      type="text/javascript"
      charset="utf-8"
    ></script>
    
    <script type="text/javascript">
      // set image viewer
      Viewer.setDefaults({
        zoomRatio: [0.5],
        navbar: false,
        toolbar: false,
        button: false,
        title: [2, (image, imageData) => `${image.alt}`],
        show: function() {
          this.viewer.zoomTo(0.5);
        }
      });
      var imageList = document.getElementsByTagName("img");
      Array.prototype.forEach.call(imageList, element => {
        var viewer = new Viewer(element);
      });
    </script>

    
    <!-- Scripts -->
    <script type="text/javascript">
    console.log("Â© zchen9 ğŸ™‹ 2015-" + new Date().getFullYear());
</script>
  
    <!-- Google Analytics -->
    

    <!-- Service Worker -->
    <!-- if using service worker -->

    
</body>

</html>