<!DOCTYPE html>
<html lang="zh-Hans">

<!-- Head tag -->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!--Description-->
    
        <meta name="description" content="0-1ï¼Œæ›´å®‰å…¨çš„è®¢é˜…">
    

    <!--Author-->
    
        <meta name="author" content="Leven">
    

    <!-- Title -->
    
    <title>Flutterçš„ä¸€äº›æ¢ç´¢2 | Leven</title>

    <!-- Bootstrap Core CSS -->
    <link href="//cdn.bootcss.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    
<link rel="stylesheet" href="/css/style.css">


    <!-- Custom Fonts -->
    <link href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Noto+Serif:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

    <!-- jQuery -->
    <script src="//cdn.bootcss.com/jquery/2.2.1/jquery.min.js"></script>
    <!-- Bootstrap -->
    <script src="//cdn.bootcss.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
<meta name="generator" content="Hexo 5.3.0"></head>

<body>

    <!-- Content -->
    <section class="article-container">
    <!-- Back Home -->
    <a class="nav-back" href="/">
    <i class="fa fa-puzzle-piece"></i>
</a>

        <!-- Page Header -->
        <header class="intro-header">
            <div class="container">
                <div class="row">
                    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                        <div class="post-heading">
                            <h1>
                                Flutterçš„ä¸€äº›æ¢ç´¢2
                            </h1>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Post Content -->
        <article>
            <div class="container">
                <div class="row">
                    <!-- Post Main Content -->
                    <div class="post-content col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                        <p>0-1ï¼Œæ›´å®‰å…¨çš„è®¢é˜…</p>
<a id="more"></a>
<h2 id="é—®é¢˜"><a href="#é—®é¢˜" class="headerlink" title="é—®é¢˜"></a>é—®é¢˜</h2><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// <span class="markdown">State</span></span></span><br><span class="line">eventBus.<span class="keyword">on</span>&lt;EventFn&gt;().listen((event) &#123;</span><br><span class="line">	<span class="comment">// do something</span></span><br><span class="line">	setState(&#123;</span><br><span class="line">		<span class="comment">///<span class="markdown">...</span></span></span><br><span class="line">	&#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>é¡µé¢popæ‰åï¼Œelementæ‰§è¡Œdisposeï¼ŒstateçŠ¶æ€è¢«è®¾ä¸ºdefunctã€‚ä½†æ˜¯æ²¡æœ‰ä»eventBusé‡Œç§»é™¤ç›‘å¬ã€‚å¯¼è‡´å†æ¬¡è§¦å‘ç›‘å¬å›è°ƒçš„æ—¶å€™è°ƒç”¨äº†setStateã€‚æ­¤æ—¶æŠ¥äº†Erroré”™è¯¯ã€‚</p>
<h2 id="è§£å†³åŠæ³•"><a href="#è§£å†³åŠæ³•" class="headerlink" title="è§£å†³åŠæ³•"></a>è§£å†³åŠæ³•</h2><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// <span class="markdown">State</span></span></span><br><span class="line"><span class="keyword">var</span> subscribe = eventBus.<span class="keyword">on</span>&lt;EventFn&gt;().listen((event) &#123;</span><br><span class="line">	<span class="comment">// do something</span></span><br><span class="line">	setState(&#123;</span><br><span class="line">		<span class="comment">///<span class="markdown">...</span></span></span><br><span class="line">	&#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">dispose()&#123;</span><br><span class="line">	**subscribe.cancel();**</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>éœ€è¦æ‰‹åŠ¨å–æ¶ˆè®¢é˜…</strong></p>
<p>å®šä¹‰subscribeå˜é‡ï¼Œæ–°å¢disposeæ–¹æ³•ï¼Œå¹¶ä¸”è°ƒç”¨subscribe.cancel()</p>
<p><img src="/images/Flutter%E7%9A%84%E4%B8%80%E4%BA%9B%E6%8E%A2%E7%B4%A22/Untitled.png" alt="Flutterçš„ä¸€äº›æ¢ç´¢2/Untitled.png"></p>
<h2 id="ä¼˜åŒ–"><a href="#ä¼˜åŒ–" class="headerlink" title="ä¼˜åŒ–"></a>ä¼˜åŒ–</h2><p>æœ‰è‡ªåŠ¨ç§»é™¤çš„subscribeè®¢é˜…å—ï¼Ÿ</p>
<p>é€šè¿‡æŸç§æ–¹å¼<strong>çŸ¥æ™“element dispose</strong>ï¼Œå¹¶ç§»é™¤ç›¸å…³çš„subscribeã€‚</p>
<h2 id="å°è¯•"><a href="#å°è¯•" class="headerlink" title="å°è¯•"></a>å°è¯•</h2><h3 id="Parent-Element"><a href="#Parent-Element" class="headerlink" title="Parent Element"></a>Parent Element</h3><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_ElementUnmountObserveElement</span> <span class="keyword">extends</span> <span class="title">StatelessElement</span> </span>&#123;</span><br><span class="line">  _ElementUnmountObserveElement(Widget widget) : <span class="keyword">super</span>(widget);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">Element</span> observedElement;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  ElementUnmountObserveWidget <span class="keyword">get</span> widget =&gt; <span class="keyword">super</span>.widget <span class="keyword">as</span> ElementUnmountObserveWidget;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> unmount() &#123;</span><br><span class="line">		<span class="comment">// è§¦å‘unmountçš„å›è°ƒ</span></span><br><span class="line">    <span class="keyword">this</span>.widget.observer.willUnmount(element: observedElement);</span><br><span class="line">    <span class="keyword">super</span>.unmount();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> mount(<span class="built_in">Element</span> parent, <span class="built_in">Object</span> newSlot) &#123;</span><br><span class="line">    <span class="keyword">super</span>.mount(parent, newSlot);</span><br><span class="line">    observedElement = parent;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/// <span class="markdown">å…¨å±€çš„ç›‘å¬Element unmountçš„ç±»</span></span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GlobalElementUnmountObserver</span> <span class="keyword">implements</span> <span class="title">ElementUnmountObserver</span> </span>&#123;</span><br><span class="line">  <span class="keyword">static</span> GlobalElementUnmountObserver instance = GlobalElementUnmountObserver();</span><br><span class="line"></span><br><span class="line">  <span class="built_in">List</span>&lt;ElementUnmountObserver&gt; _observers = [];</span><br><span class="line">  <span class="keyword">static</span> addObserver(ElementUnmountObserver observer) &#123;</span><br><span class="line">    instance._observers.add(observer);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> removeObserver(ElementUnmountObserver observer) &#123;</span><br><span class="line">    instance._observers.remove(observer);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  willUnmount(&#123;<span class="built_in">Element</span> element&#125;) &#123;</span><br><span class="line">    _observers.forEach((v) &#123;</span><br><span class="line">      v.willUnmount(element: element);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// å°è£…ç®€æ´çš„ä½¿ç”¨æ¥å£</span></span><br><span class="line"><span class="keyword">extension</span> BindMonitor <span class="keyword">on</span> Widget &#123;</span><br><span class="line">  ElementUnmountObserveWidget bindGlobalObserver() &#123;</span><br><span class="line">    <span class="keyword">return</span> ElementUnmountObserveWidget(</span><br><span class="line">      builder: (context) =&gt; <span class="keyword">this</span>,</span><br><span class="line">      observer: GlobalElementUnmountObserver.instance,</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p> ä½¿ç”¨æ–¹æ³•</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> ChangeNotifierProvider&lt;YTTDriverInfoViewModel&gt;.value(</span><br><span class="line">      value: viewModel,</span><br><span class="line">      child: Consumer&lt;YTTDriverInfoViewModel&gt;(builder: (context, model, child) &#123;</span><br><span class="line">        <span class="keyword">return</span> Scaffold(</span><br><span class="line">          appBar: CommonAppBar(</span><br><span class="line">            title: <span class="string">&#x27;ä¸ªäººä¿¡æ¯&#x27;</span>,</span><br><span class="line">            action: _createAppbarAction(viewModel),</span><br><span class="line">            elevationHeight: <span class="number">0</span>,</span><br><span class="line">          ),</span><br><span class="line">          backgroundColor: Color(<span class="number">0xFFF5F5F5</span>),</span><br><span class="line">          body: _createUI(model),</span><br><span class="line">        );</span><br><span class="line">      &#125;),</span><br><span class="line">    ).bindGlobalObserver();</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>éœ€è¦åœ¨Stateçš„buildæ–¹æ³•é‡Œæ·»åŠ <code>bindGlobalObserver()</code></p>
<p><img src="/images/Flutter%E7%9A%84%E4%B8%80%E4%BA%9B%E6%8E%A2%E7%B4%A22/522BFD4A1B8B268765F87E28275E1905.gif" alt="iOS%E5%BC%80%E5%8F%91%E5%88%B0Flutter%E5%BC%80%E5%8F%91%E7%9A%84%E6%91%B8%E7%B4%A2%20e03e8f81c9d045c49eac8ecb8f1152c9/522BFD4A1B8B268765F87E28275E1905.gif"></p>
<p>è¿˜æ˜¯è¦ä¿®æ”¹ä¸šåŠ¡çš„ä»£ç ï¼Œå…·æœ‰ä¾µå…¥æ€§ã€‚</p>
<p>Stateè¯´ï¼šæˆ‘è¿disposeéƒ½ä¸æƒ³æ”¹åŠ¨ï¼Œè¿˜æƒ³è®©æˆ‘åŠ¨widgetï¼Ÿ</p>
<h2 id="æ›´è¿›ä¸€æ­¥"><a href="#æ›´è¿›ä¸€æ­¥" class="headerlink" title="æ›´è¿›ä¸€æ­¥"></a>æ›´è¿›ä¸€æ­¥</h2><p>åˆ©ç”¨AOPå¯¹Element unmount è¿›è¡Œhook</p>
<h3 id="åŠ¨æ€æ€§"><a href="#åŠ¨æ€æ€§" class="headerlink" title="åŠ¨æ€æ€§"></a><strong>åŠ¨æ€æ€§</strong></h3><p><strong>iOS</strong></p>
<p>Objective-Cä¸ç”Ÿä¿±æ¥çš„åŠ¨æ€æ€§â€”Runtimeã€‚å¾ˆå®¹æ˜“è¿›è¡ŒAOPå’Œæ–¹æ³•æ›¿æ¢</p>
<p>åŸºäºè¯­è¨€å±‚é¢ä¸Šçš„ç‰¹æ€§ï¼Œä¸šåŠ¡ä¸Šæˆ‘ä»¬å¯ä»¥å…¨åŸ‹ç‚¹ï¼Œè¶Šç•Œä¿æŠ¤ï¼Œå¢åŠ å˜é‡ï¼Œç”šè‡³â€œçƒ­æ›´æ–°â€ç­‰</p>
<p><strong>Flutter</strong></p>
<p><img src="/images/Flutter%E7%9A%84%E4%B8%80%E4%BA%9B%E6%8E%A2%E7%B4%A22/Untitled%201.png" alt="iOS%E5%BC%80%E5%8F%91%E5%88%B0Flutter%E5%BC%80%E5%8F%91%E7%9A%84%E6%91%B8%E7%B4%A2%20e03e8f81c9d045c49eac8ecb8f1152c9/Untitled%201.png"></p>
<p>Dartæœ¬èº«æ˜¯æ”¯æŒåå°„ç‰¹æ€§ï¼Œå…·æœ‰åŠ¨æ€æ€§ã€‚ç„¶è€ŒFlutterç¦æ­¢äº†</p>
<blockquote>
<p>Flutterçš„åå°„æ¯”è¾ƒå¼±ï¼Œåªèƒ½ç”¨æ¥åšä¸€äº›Introspectå’ŒInvokeï¼Œç›®å‰ä¸å…·å¤‡Objective-Cé‚£ä¹ˆå¼ºçš„åŠ¨æ€èƒ½åŠ›ã€‚ æ®æˆ‘ä»¬äº†è§£ï¼ŒFlutterç¦æ­¢åå°„æœ€é‡è¦çš„åŸå› ä¸æ˜¯å› ä¸ºåŒ…å¤§å°ï¼Œè€Œæ˜¯ä¸ºäº†ä»£ç çš„å¯é¢„æµ‹æ€§ã€‚å®é™…ä¸Šå³ä¾¿æ‰“å¼€mirroræ”¯æŒï¼Œtree-shakingçš„é€»è¾‘ä¹Ÿæ˜¯workçš„ã€‚ ç›®å‰æˆ‘ä»¬å¯¹äºjson&lt;-&gt;modelè¿™ç§é‡‡ç”¨çš„è¿˜æ˜¯ä»£ç ç”Ÿæˆçš„æ–¹å¼ã€‚ â€”â€” æ¥è‡ªæŸä¹</p>
</blockquote>
<h3 id="AspectD"><a href="#AspectD" class="headerlink" title="AspectD"></a>AspectD</h3><p>AOPæ¡†æ¶ï¼Œæ”¯æŒå¯¹æ–¹æ³•çš„æ‰§è¡Œå‰åæ’å…¥ä»£ç ã€‚ä¹Ÿæ”¯æŒåœ¨æŒ‡å®šè¡Œæ’å…¥ä»£ç </p>
<blockquote>
<p>AspectD is an AOP(aspect oriented programming) framework for dart. Like other traditional aop framework, AspectD provides call&amp;execute grammar. Besides, as we canâ€™t use dart:mirrors in flutter, AspectD also provides a way named inject enhancing the dart code manipulation.</p>
</blockquote>
<p>æ“ä½œdartç¼–è¯‘åçš„ASTæ–‡ä»¶ï¼Œåœ¨æŒ‡å®šåœ°æ–¹æ’å…¥hookçš„ä»£ç </p>
<h3 id="ä½¿ç”¨"><a href="#ä½¿ç”¨" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h3><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Aspect</span>()</span><br><span class="line"><span class="meta">@pragma</span>(<span class="string">&quot;vm:entry-point&quot;</span>)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RegularExecuteDemo</span> </span>&#123;</span><br><span class="line">  <span class="meta">@pragma</span>(<span class="string">&quot;vm:entry-point&quot;</span>)</span><br><span class="line">  RegularExecuteDemo();</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Execute</span>(<span class="string">&quot;package:flutter/src/widgets/framework.dart&quot;</span>, <span class="string">&quot;Element&quot;</span>, <span class="string">&quot;-unmount&quot;</span>)</span><br><span class="line">  <span class="meta">@pragma</span>(<span class="string">&quot;vm:entry-point&quot;</span>)</span><br><span class="line">  <span class="built_in">dynamic</span> hookInvokeCallback(PointCut pointcut) &#123;</span><br><span class="line">    ElementHook().willUnmount(pointcut.target);</span><br><span class="line">    <span class="keyword">final</span> <span class="built_in">dynamic</span> obj = pointcut.proceed();</span><br><span class="line">    <span class="keyword">return</span> obj;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>AspectDä¼šä¿®æ”¹flutteæºç ã€‚å°†ä¸Šé¢hookä»£ç æ’å…¥åˆ°å·¥ç¨‹æŒ‡å®šçš„æ–‡ä»¶ä»£ç ä¸­</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// <span class="markdown">å·¥ç¨‹ä»£ç æ·»åŠ å¯¹æŸä¸ªelementçš„ç›‘å¬ã€‚</span></span></span><br><span class="line"><span class="keyword">static</span> hook(</span><br><span class="line">      &#123;<span class="built_in">Element</span> element,</span><br><span class="line">      ValueChanged&lt;Tuple2&lt;<span class="built_in">Element</span>, ElementHookState&gt;&gt; callback,</span><br><span class="line">      <span class="built_in">int</span> count = <span class="number">-1</span>,</span><br><span class="line">      ElementHookState hookState = ElementHookState.all&#125;) &#123;</span><br><span class="line">    ElementHook()._list.add(Tuple4(element, callback, count, hookState));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// <span class="markdown">aspectDä¸­hookåˆ°element unmount</span></span></span><br><span class="line">willUnmount(<span class="built_in">Element</span> element) &#123;</span><br><span class="line">    <span class="built_in">List</span> willRemoved = [];</span><br><span class="line"></span><br><span class="line">    _list.where((item) =&gt; item.item1 == element).forEach((item) &#123;</span><br><span class="line">      <span class="keyword">if</span> (item.item4 == ElementHookState.unmount || item.item4 == ElementHookState.all) &#123;</span><br><span class="line">        item.item2(Tuple2(element, ElementHookState.unmount));</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (item.item3 == <span class="number">1</span>) &#123;</span><br><span class="line">        willRemoved.add(item);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    _list.removeWhere((item) =&gt; willRemoved.contains(item));</span><br><span class="line"></span><br><span class="line">    _list.where((item) =&gt; item.item1 == <span class="keyword">null</span>).forEach((item) &#123;</span><br><span class="line">      item.item2(Tuple2(element, ElementHookState.unmount));</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>å®Œæ•´çš„æ— éœ€æ‰‹åŠ¨ç§»é™¤çš„è®¢é˜…</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">eventBus.<span class="keyword">on</span>&lt;EventFn&gt;().safeListen(<span class="keyword">this</span>, (event) &#123;</span><br><span class="line">     <span class="built_in">print</span>(event);</span><br><span class="line"> &#125;);</span><br></pre></td></tr></table></figure>
<p><img src="/images/Flutter%E7%9A%84%E4%B8%80%E4%BA%9B%E6%8E%A2%E7%B4%A22/D9A5146BFA8FE872EB61FACF5C66853D.gif" alt="iOS%E5%BC%80%E5%8F%91%E5%88%B0Flutter%E5%BC%80%E5%8F%91%E7%9A%84%E6%91%B8%E7%B4%A2%20e03e8f81c9d045c49eac8ecb8f1152c9/D9A5146BFA8FE872EB61FACF5C66853D.gif"></p>
<p>çœ‹ä»£ç </p>
<p><img src="/images/Flutter%E7%9A%84%E4%B8%80%E4%BA%9B%E6%8E%A2%E7%B4%A22/Untitled%202.png" alt="iOS%E5%BC%80%E5%8F%91%E5%88%B0Flutter%E5%BC%80%E5%8F%91%E7%9A%84%E6%91%B8%E7%B4%A2%20e03e8f81c9d045c49eac8ecb8f1152c9/Untitled%202.png"></p>
<ol>
<li>stream_extension.dart</li>
</ol>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extension</span> Safe <span class="keyword">on</span> Stream &#123;</span><br><span class="line">  safeListen&lt;T&gt;(State state, <span class="keyword">void</span> onData(T event)) &#123;</span><br><span class="line">    state.subscribe = listen(onData);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>state_extension.dart</li>
</ol>
<p>ç»™StateåŠ¨æ€æ·»åŠ subscribeså˜é‡</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extension</span> Asociate <span class="keyword">on</span> State &#123;</span><br><span class="line">  <span class="built_in">List</span>&lt;StreamSubscription&gt; <span class="keyword">get</span> subscribes =&gt; AsociateCenter().getsetAsociateValue(state: <span class="keyword">this</span>, key: <span class="string">&quot;subscribes&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">set</span> subscribe(StreamSubscription value) &#123;</span><br><span class="line">    <span class="built_in">List</span>&lt;StreamSubscription&gt; cachedSubscribes = subscribes ?? [];</span><br><span class="line">    cachedSubscribes.add(value);</span><br><span class="line">    AsociateCenter().setAsociate(state: <span class="keyword">this</span>, key: <span class="string">&quot;subscribes&quot;</span>, value: cachedSubscribes);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>3.asociate_center.dart</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">AsociateCenter._internal() &#123;</span><br><span class="line">   ElementHook.hook(callback: (tuple) &#123;</span><br><span class="line">     elementStateUpdate(element: tuple.item1, state: tuple.item2);</span><br><span class="line">   &#125;);</span><br><span class="line"> &#125;</span><br><span class="line"><span class="built_in">Map</span>&lt;<span class="built_in">int</span>, <span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="built_in">dynamic</span>&gt;&gt; _asociateCenterMap = &#123;&#125;;</span><br><span class="line"></span><br><span class="line"> elementStateUpdate(&#123;<span class="built_in">Element</span> element, ElementHookState state&#125;) &#123;</span><br><span class="line">   <span class="keyword">if</span> (state != ElementHookState.unmount || element <span class="keyword">is</span>! StatefulElement) &#123;</span><br><span class="line">     <span class="keyword">return</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/// <span class="markdown">cancelæ‰StatefulElement.Stateä¸­çš„subscription</span></span></span><br><span class="line">   (element <span class="keyword">as</span> StatefulElement).state.subscribes?.forEach((element) &#123;</span><br><span class="line">     element.cancel();</span><br><span class="line">   &#125;);</span><br><span class="line"></span><br><span class="line">   <span class="comment">/// <span class="markdown">ç§»é™¤StatefulElement.Stateä¸­ç»‘å®šçš„å±æ€§</span></span></span><br><span class="line">   _asociateCenterMap.remove((element <span class="keyword">as</span> StatefulElement).state.hashCode);</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> setAsociate(&#123;State state, <span class="built_in">dynamic</span> value, <span class="built_in">String</span> key&#125;) &#123;</span><br><span class="line">   <span class="built_in">int</span> hashState = state.hashCode;</span><br><span class="line">   <span class="keyword">if</span> (_asociateCenterMap.containsKey(hashState)) &#123;</span><br><span class="line">     _asociateCenterMap[hashState][key] = value;</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">     <span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="built_in">dynamic</span>&gt; map = &#123;&#125;;</span><br><span class="line">     map[key] = value;</span><br><span class="line">     _asociateCenterMap[hashState] = map;</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="built_in">dynamic</span> getsetAsociateValue(&#123;State state, <span class="built_in">String</span> key&#125;) &#123;</span><br><span class="line">   <span class="built_in">int</span> hashState = state.hashCode;</span><br><span class="line">   <span class="keyword">if</span> (_asociateCenterMap.containsKey(hashState)) &#123;</span><br><span class="line">     <span class="keyword">return</span> _asociateCenterMap[hashState][key];</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<h2 id="æœ€å"><a href="#æœ€å" class="headerlink" title="æœ€å"></a>æœ€å</h2><p><img src="/images/Flutter%E7%9A%84%E4%B8%80%E4%BA%9B%E6%8E%A2%E7%B4%A22/Untitled%203.png" alt="iOS%E5%BC%80%E5%8F%91%E5%88%B0Flutter%E5%BC%80%E5%8F%91%E7%9A%84%E6%91%B8%E7%B4%A2%20e03e8f81c9d045c49eac8ecb8f1152c9/Untitled%203.png"></p>
<ol>
<li>â€œæ‡’â€æ˜¯ç¬¬ä¸€æŠ€æœ¯ç”Ÿäº§</li>
</ol>
<p>ä¸ºäº†æ‡’å¾—å¿ƒå®‰ï¼Œæˆ‘ä»¬ä¼šå»å¯»æ‰¾æ›´ä¾¿æ·ï¼Œæ›´å®‰å…¨çš„è§£å†³æ–¹æ¡ˆã€‚æ¢ç´¢çš„è¿‡ç¨‹èƒ½æ‹“å±•çŸ¥è¯†é¢å’ŒæŠ€æœ¯æ·±åº¦ã€‚</p>
<ol>
<li>AspectDè¿˜æ²¡æ‰¾åˆ°æ”¯æŒhookèŒƒå‹æ–¹æ³•çš„æ–¹å¼ï¼Œä¸ä½œè€…æ²Ÿé€šå½“ä¸­ã€‚</li>
<li>AspectDåº”è¯¥èƒ½è®©åœ¨åº•å±‚æ›´å¥½çš„æ”¯æ’‘ä¸šåŠ¡å±‚åŸ‹ç‚¹çš„ä¾¿æ·æ€§ã€‚</li>
</ol>


                            <!-- Meta -->
                            <div class="post-meta">
                                <hr>
                                <br>
                                <div class="post-tags">
                                    
                                </div>
                                <div class="post-date">
                                    2021-07-26
                                </div>
                            </div>
                    </div>

                    <!-- Comments -->
                    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                        <!-- Disqus Comments -->


                    </div>
                </div>
            </div>
        </article>
</section>

<!-- Image viewer-->

    <!-- Custom picture view-->
    <link href="/css/viewer.min.css" rel="stylesheet" />
    <script
      src="/js/viewer.min.js"
      type="text/javascript"
      charset="utf-8"
    ></script>
    
    <script type="text/javascript">
      // set image viewer
      Viewer.setDefaults({
        zoomRatio: [0.5],
        navbar: false,
        toolbar: false,
        button: false,
        title: [2, (image, imageData) => `${image.alt}`],
        show: function() {
          this.viewer.zoomTo(0.5);
        }
      });
      var imageList = document.getElementsByTagName("img");
      Array.prototype.forEach.call(imageList, element => {
        var viewer = new Viewer(element);
      });
    </script>

    
    <!-- Scripts -->
    <script type="text/javascript">
    console.log("Â© zchen9 ğŸ™‹ 2015-" + new Date().getFullYear());
</script>
  
    <!-- Google Analytics -->
    

    <!-- Service Worker -->
    <!-- if using service worker -->

    
</body>

</html>